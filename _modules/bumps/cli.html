<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bumps.cli &#8212; Bumps 0.9.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script src="../../_static/documentation_options.js?v=9dc39874"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" accesskey="U">bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.cli</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bumps.cli</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Bumps command line interface.</span>

<span class="sd">The functions in this module are used by the bumps command to implement</span>
<span class="sd">the command line interface.  Bumps plugin models can use them to create</span>
<span class="sd">stand alone applications with a similar interface.  For example, the</span>
<span class="sd">Refl1D application uses the following::</span>

<span class="sd">    from . import fitplugin</span>
<span class="sd">    import bumps.cli</span>
<span class="sd">    bumps.cli.set_mplconfig(appdatadir=&#39;Refl1D&#39;)</span>
<span class="sd">    bumps.cli.install_plugin(fitplugin)</span>
<span class="sd">    bumps.cli.main()</span>

<span class="sd">After completing a set of fits on related systems, a post-analysis script</span>
<span class="sd">can use :func:`load_model` to load the problem definition and</span>
<span class="sd">:func:`load_best` to load the best value  found in the fit.  This can</span>
<span class="sd">be used for example in experiment design, where you look at the expected</span>
<span class="sd">parameter uncertainty when fitting simulated data from a range of experimental</span>
<span class="sd">systems.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span><span class="p">,</span> <span class="n">print_function</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;install_plugin&quot;</span><span class="p">,</span> <span class="s2">&quot;set_mplconfig&quot;</span><span class="p">,</span> <span class="s2">&quot;config_matplotlib&quot;</span><span class="p">,</span>
           <span class="s2">&quot;load_model&quot;</span><span class="p">,</span> <span class="s2">&quot;preview&quot;</span><span class="p">,</span> <span class="s2">&quot;load_best&quot;</span><span class="p">,</span> <span class="s2">&quot;save_best&quot;</span><span class="p">,</span> <span class="s2">&quot;resynth&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># np.seterr(all=&quot;raise&quot;)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fitters</span>
<span class="kn">from</span> <span class="nn">.fitters</span> <span class="kn">import</span> <span class="n">FitDriver</span><span class="p">,</span> <span class="n">StepMonitor</span><span class="p">,</span> <span class="n">ConsoleMonitor</span><span class="p">,</span> <span class="n">CheckpointMonitor</span><span class="p">,</span> <span class="n">nllf_scale</span>
<span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">MPMapper</span><span class="p">,</span> <span class="n">AMQPMapper</span><span class="p">,</span> <span class="n">MPIMapper</span><span class="p">,</span> <span class="n">SerialMapper</span>
<span class="kn">from</span> <span class="nn">.formatnum</span> <span class="kn">import</span> <span class="n">format_uncertainty</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">initpop</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">plugin</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">options</span>

<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">pushdir</span><span class="p">,</span> <span class="n">push_python_path</span>


<div class="viewcode-block" id="install_plugin">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.install_plugin">[docs]</a>
<span class="k">def</span> <span class="nf">install_plugin</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace symbols in :mod:`bumps.plugin` with application specific</span>
<span class="sd">    methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">plugin</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">symbol</span><span class="p">))</span></div>



<div class="viewcode-block" id="load_model">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.load_model">[docs]</a>
<span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">model_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a model file.</span>

<span class="sd">    *path* contains the path to the model file.</span>

<span class="sd">    *model_options* are any additional arguments to the model.  The sys.argv</span>
<span class="sd">    variable will be set such that *sys.argv[1:] == model_options*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.fitproblem</span> <span class="kn">import</span> <span class="n">load_problem</span>

    <span class="c1"># Change to the target path before loading model so that data files</span>
    <span class="c1"># can be given as relative paths in the model file.  Add the directory</span>
    <span class="c1"># to the python path (at the end) so that imports work as expected.</span>
    <span class="n">directory</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pushdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="c1"># Try a specialized model loader</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">problem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># print &quot;loading&quot;,filename,&quot;from&quot;,directory</span>
            <span class="c1"># TODO: eliminate pickle!!</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">dill</span> <span class="k">as</span> <span class="nn">pickle</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pickle</span>
                <span class="c1"># First see if it is a pickle</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">problem</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Then see if it is a python model script</span>
                <span class="n">problem</span> <span class="o">=</span> <span class="n">load_problem</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">model_options</span><span class="p">)</span>

    <span class="c1"># Guard against the user changing parameters after defining the problem.</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">model_reset</span><span class="p">()</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">):</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">model_options</span>
    <span class="k">return</span> <span class="n">problem</span></div>



<div class="viewcode-block" id="preview">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.preview">[docs]</a>
<span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show the problem plots and parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pylab</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="save_best">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.save_best">[docs]</a>
<span class="k">def</span> <span class="nf">save_best</span><span class="p">(</span><span class="n">fitdriver</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the fit data, including parameter values, uncertainties and plots.</span>

<span class="sd">    *fitdriver* is the fitter that was used to drive the fit.</span>

<span class="sd">    *problem* is a FitProblem instance.</span>

<span class="sd">    *best* is the parameter set to save.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure the problem contains the best value</span>
    <span class="c1"># TODO: avoid recalculating if problem is already at best.</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>
    <span class="c1"># print &quot;remembering best&quot;</span>
    <span class="n">pardata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%.15g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">labels</span><span class="p">(),</span> <span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()))</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.par&quot;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pardata</span><span class="p">)</span>

    <span class="n">fitdriver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">redirect_console</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.err&quot;</span><span class="p">):</span>
        <span class="n">fitdriver</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">fitdriver</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">)</span>
    <span class="n">fitdriver</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="c1"># print &quot;plotting&quot;</span>


<span class="n">PARS_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?P&lt;label&gt;.*) (?P&lt;value&gt;[^ ]*)\n$&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="load_best">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.load_best">[docs]</a>
<span class="k">def</span> <span class="nf">load_best</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reload individual parameter values from a saved .par file.</span>

<span class="sd">    If the label does not exist in the file, use the value from the model</span>
<span class="sd">    as the default value. Ignore labels that do not exist in the model. In</span>
<span class="sd">    that way we can load parameters from an old fit with minimal fuss, even</span>
<span class="sd">    as we add, delete and move parameters in the model. If any parameters</span>
<span class="sd">    are missing, set *problem.undefined* to the a boolean index of the</span>
<span class="sd">    undefined parameters.</span>

<span class="sd">    There is an interaction with --init=eps and the par file. If any parameters</span>
<span class="sd">    are missing from the par file they will be randomized across the</span>
<span class="sd">    entire parameter range using the equivalent of --init=lhs. That means</span>
<span class="sd">    you can drop a # at the beginning of the line in the .par file</span>
<span class="sd">    and that parameter will be shuffled on restart, with the remaining</span>
<span class="sd">    parameters starting near the initial value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># WARNING: Labels are not unique! Need to track multiple instances of</span>
    <span class="c1"># the same label.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.par&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter file </span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">PARS_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>
            <span class="c1"># Accumulate values for labels only if they appear in the model.</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="n">targets</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Populate model with named parameters in the order they occur in the</span>
    <span class="c1"># parameter file. Identify the missing parameters if any, adding them</span>
    <span class="c1"># to the the problem definition as an optional &quot;undefined&quot; attribute with</span>
    <span class="c1"># one bit for each parameter. This ugly hack is to support a previous</span>
    <span class="c1"># ugly hack in which undefined parameters are initialized with LHS but</span>
    <span class="c1"># defined parameters are initialized with eps, cov or random.</span>
    <span class="c1"># TODO: find a better way to &quot;free&quot; parameters on --pars.</span>
    <span class="c1"># TODO: find a way to &quot;free&quot; parameters on --resume.</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">undefined</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">default_value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()):</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="n">is_empty</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">remaining</span>
        <span class="c1"># popping the next value from remaining modifies targets[label]</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_value</span> <span class="k">if</span> <span class="n">is_empty</span> <span class="k">else</span> <span class="n">remaining</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">undefined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_empty</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">undefined</span><span class="p">):</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">undefined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">undefined</span><span class="p">)</span></div>

<span class="c1">#CRUFT</span>
<span class="n">recall_best</span> <span class="o">=</span> <span class="n">load_best</span>


<span class="k">def</span> <span class="nf">store_overwrite_query_gui</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask if store path should be overwritten.</span>

<span class="sd">    Use this in a call to :func:`make_store` from a graphical user interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wx</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot; already exists. Press &#39;yes&#39; to overwrite, or &#39;No&#39; to abort and restart with newpath&quot;</span>
    <span class="n">msg_dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;Overwrite Directory&#39;</span><span class="p">,</span>
                               <span class="n">wx</span><span class="o">.</span><span class="n">YES_NO</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_QUESTION</span><span class="p">)</span>
    <span class="n">retCode</span> <span class="o">=</span> <span class="n">msg_dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
    <span class="n">msg_dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">retCode</span> <span class="o">!=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_YES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not create path&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">store_overwrite_query</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask if store path should be overwritten.</span>

<span class="sd">    Use this in a call to :func:`make_store` from a command line interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;already exists.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Press &#39;y&#39; to overwrite, or &#39;n&#39; to abort and restart with --overwrite, --resume, or --store=newpath&quot;</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Overwrite [y/n]? &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_store</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">exists_handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the store directory and populate it with the model definition file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine if command line override</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">store</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Need to specify &#39;--store=path&#39; on command line&quot;</span>
            <span class="s2">&quot; or problem.store=&#39;path&#39; in definition file.&quot;</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Check if already exists</span>
    <span class="n">store_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="s1">&#39;.par&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">resume</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">store_exists</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batch</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">problem</span><span class="o">.</span><span class="n">store</span> <span class="o">+</span> <span class="s2">&quot; already exists.  Restart with --overwrite, --resume, or --store=newpath&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">exists_handler</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>

    <span class="c1"># Create it and copy model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">store</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_profiler</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model execution profiler.</span>

<span class="sd">    Run the program with &quot;--profiler --steps=N&quot; to generate a function</span>
<span class="sd">    profile chart breaking down the cost of evaluating N models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Here is the findings from one profiling session::</span>
    <span class="c1">#   23 ms total</span>
    <span class="c1">#    6 ms rendering model</span>
    <span class="c1">#    8 ms abeles</span>
    <span class="c1">#    4 ms convolution</span>
    <span class="c1">#    1 ms setting parameters and computing nllf</span>
    <span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">profile</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">initpop</span><span class="o">.</span><span class="n">random_init</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">)</span>
    <span class="c1"># Note: map is an iterator in python 3</span>
    <span class="n">profile</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)),</span> <span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_timer</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model execution timer.</span>

<span class="sd">    Run the program with &quot;--timer --steps=N&quot; to determine the average</span>
<span class="sd">    run time of the model.  If --parallel is included, then the model</span>
<span class="sd">    will be run in parallel on separate cores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">initpop</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="n">problem</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="n">pop</span><span class="o">=-</span><span class="n">steps</span><span class="p">,</span> <span class="n">use_point</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
        <span class="c1"># No fitting parameters --- generate an empty population</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">mapper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time per model eval: </span><span class="si">%g</span><span class="s2"> ms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">T0</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">start_remote_fit</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">notify</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queue remote fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">jobqueue.client</span> <span class="kn">import</span> <span class="n">connect</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">dill</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">dill_dumps</span>
        <span class="n">dumps</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">dill_dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">dumps</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="s1">&#39;bumps&#39;</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
                <span class="n">problem</span><span class="o">=</span><span class="n">dumps</span><span class="p">(</span><span class="n">problem</span><span class="p">),</span>
                <span class="n">options</span><span class="o">=</span><span class="n">dumps</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
    <span class="n">request</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="s1">&#39;fitter&#39;</span><span class="p">,</span>
                   <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>  <span class="c1"># fitter service version</span>
                   <span class="n">notify</span><span class="o">=</span><span class="n">notify</span><span class="p">,</span>
                   <span class="n">name</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                   <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">job</span>

<span class="c1"># ==== Main ====</span>


<span class="k">def</span> <span class="nf">initial_model</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and initialize the model.</span>

<span class="sd">    *opts* are the processed command line options.</span>

<span class="sd">    If --pars is in opts, then load the parameters from a .par file.</span>

<span class="sd">    If --simulate is in opts, then generate random data from the model.</span>

<span class="sd">    If --simrandom is in opts, then generate random data from a random model.</span>

<span class="sd">    If --shake is in opts, then use a random initial state for the fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opts</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">pars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">load_best</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">simrandom</span><span class="p">:</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">randomize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">simulate</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">simrandom</span><span class="p">:</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">noise</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">noise</span><span class="p">)</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">simulate_data</span><span class="p">(</span><span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulation parameters&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">summarize</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chisq at simulation&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">chisq_str</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">shake</span><span class="p">:</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">randomize</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">problem</span>


<div class="viewcode-block" id="resynth">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.resynth">[docs]</a>
<span class="k">def</span> <span class="nf">resynth</span><span class="p">(</span><span class="n">fitdriver</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate maximum likelihood fits to resynthesized data sets.</span>

<span class="sd">    *fitdriver* is a :class:`bumps.fitters.FitDriver` object with a fitter</span>
<span class="sd">    already chosen.</span>

<span class="sd">    *problem* is a :func:`bumps.fitproblem.FitProblem` object.  It should</span>
<span class="sd">    be initialized with optimal values for the parameters.</span>

<span class="sd">    *mapper* is one of the available :mod:`bumps.mapper` classes.</span>

<span class="sd">    *opts* is a :class:`bumps.options.BumpsOpts` object representing the command</span>
<span class="sd">    line parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">make_store</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">exists_handler</span><span class="o">=</span><span class="n">store_overwrite_query</span><span class="p">)</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.rsy&quot;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">)</span>
    <span class="n">fitdriver</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">start_mapper</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">resynth</span><span class="p">):</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">resynth_data</span><span class="p">()</span>
        <span class="n">best</span><span class="p">,</span> <span class="n">fbest</span> <span class="o">=</span> <span class="n">fitdriver</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">scale</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">nllf_scale</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;step </span><span class="si">%d</span><span class="s2"> chisq </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">fbest</span><span class="p">))</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.15g</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">fbest</span><span class="p">))</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.15g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">best</span><span class="p">))</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">restore_data</span><span class="p">()</span>
    <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="set_mplconfig">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.set_mplconfig">[docs]</a>
<span class="k">def</span> <span class="nf">set_mplconfig</span><span class="p">(</span><span class="n">appdatadir</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Point the matplotlib config dir to %LOCALAPPDATA%\{appdatadir}\mplconfig.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;frozen&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
            <span class="n">mplconfigdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LOCALAPPDATA&#39;</span><span class="p">],</span> <span class="n">appdatadir</span><span class="p">,</span> <span class="s1">&#39;mplconfig&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
            <span class="n">mplconfigdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/Library/Caches&#39;</span><span class="p">),</span> <span class="n">appdatadir</span><span class="p">,</span> <span class="s1">&#39;mplconfig&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># do nothing on linux</span>
        <span class="n">mplconfigdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;MPLCONFIGDIR&#39;</span><span class="p">,</span> <span class="n">mplconfigdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mplconfigdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mplconfigdir</span><span class="p">)</span></div>



<div class="viewcode-block" id="config_matplotlib">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.config_matplotlib">[docs]</a>
<span class="k">def</span> <span class="nf">config_matplotlib</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup matplotlib to use a particular backend.</span>

<span class="sd">    The backend should be &#39;WXAgg&#39; for interactive use, or &#39;Agg&#39; for batch.</span>
<span class="sd">    This distinction allows us to run in environments such as cluster computers</span>
<span class="sd">    which do not have wx installed on the compute nodes.</span>

<span class="sd">    This function must be called before any imports to pylab.  To allow</span>
<span class="sd">    this, modules should not import pylab at the module level, but instead</span>
<span class="sd">    import it for each function/method that uses it.  Exceptions can be made</span>
<span class="sd">    for modules which are completely dedicated to plotting, but these modules</span>
<span class="sd">    should never be imported at the module level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

    <span class="c1"># When running from a frozen environment created by py2exe, we will not</span>
    <span class="c1"># have a range of backends available, and must set the default to WXAgg.</span>
    <span class="c1"># With a full matplotlib distribution we can use whatever the user prefers.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;frozen&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;MPLCONFIGDIR&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;MPLCONFIGDIR should be set to e.g., %LOCALAPPDATA%\YourApp\mplconfig&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backend</span> <span class="o">=</span> <span class="s1">&#39;WXAgg&#39;</span>

    <span class="c1">## CRUFT: check that backend is valid, trying alternates if an import fails</span>
    <span class="c1">#if backend is None:</span>
    <span class="c1">#    backend = os.environ.get(&#39;MPLBACKEND&#39;, mpl.rcParams[&#39;backend&#39;])</span>
    <span class="c1">#import importlib</span>
    <span class="c1">#for name in (backend, &#39;MacOSX&#39;, &#39;Qt5Agg&#39;, &#39;Qt4Agg&#39;, &#39;Gtk3Agg&#39;, &#39;TkAgg&#39;, &#39;WXAgg&#39;):</span>
    <span class="c1">#    path = &#39;matplotlib.backends.backend_&#39; + name.lower()</span>
    <span class="c1">#    try:</span>
    <span class="c1">#        importlib.import_module(path)</span>
    <span class="c1">#        backend = name</span>
    <span class="c1">#        break</span>
    <span class="c1">#    except ImportError:</span>
    <span class="c1">#        backend = None</span>

    <span class="c1"># Specify the backend to use for plotting and import backend dependent</span>
    <span class="c1"># classes.  This must be done before importing pyplot to have an</span>
    <span class="c1"># effect.  If no backend is given, let pyplot use the default.</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>

    <span class="c1"># Disable interactive mode so that plots are only updated on show() or</span>
    <span class="c1"># draw(). The interactive function must be called before importing pyplot,</span>
    <span class="c1"># otherwise it will have no effect.</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#configure the plot style</span>
    <span class="n">line_width</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Arial&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="k">else</span> <span class="s1">&#39;sans-serif&#39;</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">plot_style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;xtick.direction&#39;</span><span class="p">:</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ytick.direction&#39;</span><span class="p">:</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lines.linewidth&#39;</span><span class="p">:</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="s1">&#39;axes.linewidth&#39;</span><span class="p">:</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">,</span>
        <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">,</span>
        <span class="s1">&#39;xtick.major.size&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;ytick.major.size&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;xtick.minor.size&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;ytick.minor.size&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;xtick.major.width&#39;</span><span class="p">:</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="s1">&#39;ytick.major.width&#39;</span><span class="p">:</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="s1">&#39;xtick.minor.width&#39;</span><span class="p">:</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="s1">&#39;ytick.minor.width&#39;</span><span class="p">:</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="s1">&#39;xtick.major.pad&#39;</span><span class="p">:</span> <span class="n">pad</span><span class="p">,</span>
        <span class="s1">&#39;ytick.major.pad&#39;</span><span class="p">:</span> <span class="n">pad</span><span class="p">,</span>
        <span class="s1">&#39;xtick.top&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;ytick.right&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">,</span>
        <span class="s1">&#39;font.family&#39;</span><span class="p">:</span> <span class="n">font_family</span><span class="p">,</span>
        <span class="s1">&#39;svg.fonttype&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="s1">&#39;savefig.dpi&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_style</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">beep</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Audio signal that fit is complete.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">winsound</span>
            <span class="n">winsound</span><span class="o">.</span><span class="n">MessageBeep</span><span class="p">(</span><span class="n">winsound</span><span class="o">.</span><span class="n">MB_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\a</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run an arbitrary python command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start logger&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># From http://stackoverflow.com/questions/22373927/get-traceback-of-warnings</span>
<span class="c1"># answered by mgab (2014-03-13)</span>
<span class="c1"># edited by Gareth Rees (2015-11-28)</span>
<span class="k">def</span> <span class="nf">warn_with_traceback</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
                        <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alternate warning printer which shows a traceback with the warning.</span>

<span class="sd">    To use, set *warnings.showwarning = warn_with_traceback*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">file</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../bumps.cli.html#bumps.cli.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the bumps program with the command line interface.</span>

<span class="sd">    Input parameters are taken from sys.argv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># add full traceback to warnings</span>
    <span class="c1">#warnings.showwarning = warn_with_traceback</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-?&quot;</span><span class="p">)</span>

    <span class="c1"># run command with bumps in the environment</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-m&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">runpy</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">runpy</span><span class="o">.</span><span class="n">run_module</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;__main__&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-p&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">runpy</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">runpy</span><span class="o">.</span><span class="n">run_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;__main__&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-c&#39;</span><span class="p">:</span>
        <span class="n">run_command</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-i&#39;</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ipython&quot;</span><span class="p">,</span> <span class="s2">&quot;--pylab&quot;</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">start_ipython</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">start_ipython</span><span class="p">())</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">getopts</span><span class="p">()</span>
    <span class="n">setup_logging</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">edit</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.gui.gui_app</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">gui</span>
        <span class="n">gui</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="c1"># Set up the matplotlib backend to minimize the wx/gui dependency.</span>
    <span class="c1"># If no GUI specified and not editing, then use the default mpl</span>
    <span class="c1"># backend for the python version.</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batch</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">remote</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">noshow</span><span class="p">:</span>  <span class="c1"># no interactivity</span>
        <span class="n">config_matplotlib</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># let preview use default graphs</span>
        <span class="n">config_matplotlib</span><span class="p">()</span>

    <span class="n">problem</span> <span class="o">=</span> <span class="n">initial_model</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">problem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!!! Model file missing from command line --- abort !!!.&quot;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># TODO: AMQP mapper as implemented requires workers started up with</span>
    <span class="c1"># the particular problem; need to be able to transport the problem</span>
    <span class="c1"># to the worker instead.  Until that happens, the GUI shouldn&#39;t use</span>
    <span class="c1"># the AMQP mapper.</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">mpi</span><span class="p">:</span>
        <span class="n">MPIMapper</span><span class="o">.</span><span class="n">start_worker</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">MPIMapper</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">parallel</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">worker</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">transport</span> <span class="o">==</span> <span class="s1">&#39;amqp&#39;</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">AMQPMapper</span>
        <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">transport</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">MPMapper</span>
        <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">transport</span> <span class="o">==</span> <span class="s1">&#39;celery&#39;</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">CeleryMapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown mapper&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">SerialMapper</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">worker</span><span class="p">:</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">start_worker</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">time</span><span class="p">)):</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span>
        <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">stop_time</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>

    <span class="n">fitdriver</span> <span class="o">=</span> <span class="n">FitDriver</span><span class="p">(</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">fit_config</span><span class="o">.</span><span class="n">selected_fitter</span><span class="p">,</span> <span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="n">abort_test</span><span class="p">,</span>
        <span class="o">**</span><span class="n">opts</span><span class="o">.</span><span class="n">fit_config</span><span class="o">.</span><span class="n">selected_values</span><span class="p">)</span>

    <span class="c1"># Start fitter within the domain so that constraints are valid</span>
    <span class="n">clipped</span> <span class="o">=</span> <span class="n">fitdriver</span><span class="o">.</span><span class="n">clip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">clipped</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start value clipped to range for parameter&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clipped</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">time_model</span><span class="p">:</span>
        <span class="n">run_timer</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">start_mapper</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                  <span class="n">problem</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">steps</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
        <span class="n">run_profiler</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">steps</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">chisq</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cov</span><span class="p">:</span>
            <span class="n">fitdriver</span><span class="o">.</span><span class="n">show_cov</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chisq&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">chisq_str</span><span class="p">())</span>
        <span class="c1">#import pprint; pprint.pprint(problem.to_dict(), indent=2, width=272)</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">preview</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cov</span><span class="p">:</span>
            <span class="n">fitdriver</span><span class="o">.</span><span class="n">show_cov</span><span class="p">()</span>
        <span class="n">preview</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">resynth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">resynth</span><span class="p">(</span><span class="n">fitdriver</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">remote</span><span class="p">:</span>
        <span class="c1"># Check that problem runs before submitting it remotely</span>
        <span class="c1"># TODO: this may fail if problem requires remote resources such as GPU</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial chisq:&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">chisq_str</span><span class="p">())</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">start_remote_fit</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
                               <span class="n">queue</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">notify</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;remote job:&quot;</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Show command line arguments and initial model</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),</span> <span class="s2">&quot;--seed=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">opts</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Check that there are parameters to be fitted.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!!! No parameters selected for fitting---abort !!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Run the fit</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">resume</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">store</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">store</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
            <span class="n">resume_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">resume</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resume_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">make_store</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">exists_handler</span><span class="o">=</span><span class="n">store_overwrite_query</span><span class="p">)</span>

        <span class="c1"># Redirect sys.stdout to capture progress</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batch</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.mon&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: fix techical debt with checkpoint monitor implementation</span>
        <span class="c1"># * The current checkpoint implementation is self-referential:</span>
        <span class="c1">#     checkpoint = lambda: save_best(fitdriver, ...)</span>
        <span class="c1">#     fitdriver.monitors = [..., CheckpointMonitor(checkpoint), ...]</span>
        <span class="c1">#   It is done this way because the checkpoint monitor needs the fitter</span>
        <span class="c1">#   so it can ask it to save state, but the fitter needs the list of</span>
        <span class="c1">#   monitors, including the checkpoint monitor, before it is run.</span>
        <span class="c1"># * Figures are cumulative, with each checkpoint adding a new set</span>
        <span class="c1"># * Figures are slow! Can they go into a separate thread?  Can we</span>
        <span class="c1">#   have the problem cache the best value?</span>
        <span class="n">checkpoint_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span>
        <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="n">fitdriver</span><span class="o">.</span><span class="n">problem</span>
            <span class="c1">## Use the following to save only the fitter state</span>
            <span class="n">fitdriver</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
            <span class="c1">## Use the following to save the fitter state plus all other</span>
            <span class="c1">## plots and other output files.  This won&#39;t work yet since</span>
            <span class="c1">## plots are generated sequentially, with each checkpoint producing</span>
            <span class="c1">## a completely new set of plots.</span>
            <span class="c1">#best = history.point[0]</span>
            <span class="c1">#save_best(fitdriver, problem, best, view=opts.view)</span>
        <span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConsoleMonitor</span><span class="p">(</span><span class="n">problem</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">checkpoint_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">checkpoint_time</span><span class="p">):</span>
            <span class="n">mon</span> <span class="o">=</span> <span class="n">CheckpointMonitor</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">checkpoint_time</span><span class="p">)</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">stepmon</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">mon</span> <span class="o">=</span> <span class="n">StepMonitor</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span>
        <span class="n">fitdriver</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="n">monitors</span>

        <span class="c1">#import time; t0=time.clock()</span>
        <span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span> <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">parallel</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fitdriver</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">start_mapper</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">cpus</span><span class="o">=</span><span class="n">cpus</span><span class="p">)</span>
        <span class="n">best</span><span class="p">,</span> <span class="n">fbest</span> <span class="o">=</span> <span class="n">fitdriver</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">resume</span><span class="o">=</span><span class="n">resume_path</span><span class="p">)</span>
        <span class="c1"># print(&quot;time=%g&quot;%(time.clock()-t0),file=sys.__stdout__)</span>
        <span class="c1"># Note: keep this in sync with the checkpoint function above</span>
        <span class="n">save_best</span><span class="p">(</span><span class="n">fitdriver</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">err</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">cov</span><span class="p">:</span>
            <span class="n">fitdriver</span><span class="o">.</span><span class="n">show_err</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cov</span><span class="p">:</span>
            <span class="n">fitdriver</span><span class="o">.</span><span class="n">show_cov</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
            <span class="n">fitdriver</span><span class="o">.</span><span class="n">show_entropy</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">entropy</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">stop_mapper</span><span class="p">(</span><span class="n">fitdriver</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>

        <span class="c1"># If in batch mode then explicitly close the monitor file on completion</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">batch</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>

        <span class="c1"># Display the plots</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">batch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">mpi</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">noshow</span><span class="p">:</span>
            <span class="n">beep</span><span class="p">()</span>
            <span class="kn">import</span> <span class="nn">pylab</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<span class="c1"># Allow  &quot;$python -m bumps.cli args&quot; calling pattern</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" >bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.cli</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>