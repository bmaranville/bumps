<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bumps.bspline &#8212; Bumps 0.9.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script src="../../_static/documentation_options.js?v=9dc39874"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" accesskey="U">bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.bspline</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bumps.bspline</h1><div class="highlight"><pre>
<span></span><span class="c1"># This program is public domain</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">BSpline calculator.</span>

<span class="sd">Given a set of knots, compute the cubic B-spline interpolation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bspline&#39;</span><span class="p">,</span> <span class="s1">&#39;pbs&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">maximum</span> <span class="k">as</span> <span class="nb">max</span><span class="p">,</span> <span class="n">minimum</span> <span class="k">as</span> <span class="nb">min</span>


<div class="viewcode-block" id="pbs">
<a class="viewcode-back" href="../../bumps.bspline.html#bumps.bspline.pbs">[docs]</a>
<span class="k">def</span> <span class="nf">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the parametric B-spline px(t),py(t).</span>

<span class="sd">    *x* and *y* are the control points, and *t* are the points</span>
<span class="sd">    in [0,1] at which they are evaluated.   The *x* values are</span>
<span class="sd">    sorted so that the spline describes a function.</span>

<span class="sd">    The spline goes through the control points at the ends. If *clamp*</span>
<span class="sd">    is True, the derivative of the spline at both ends is zero. If *clamp*</span>
<span class="sd">    is False, the derivative at the ends is equal to the slope connecting</span>
<span class="sd">    the final pair of control points.</span>

<span class="sd">    If *parametric* is False, then parametric points t&#39; are chosen such</span>
<span class="sd">    that x(t&#39;) = *t*.</span>

<span class="sd">    The B-spline knots are chosen to be equally spaced within [0,1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">knot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">parametric</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># Find parametric t values corresponding to given z values</span>
    <span class="c1"># First try a few newton steps</span>
    <span class="n">xt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">pt</span><span class="p">,</span> <span class="n">dpt</span> <span class="o">=</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">nderiv</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">xt</span> <span class="o">-=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">dpt</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">xt</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span>

    <span class="c1"># Use bisection when newton fails</span>
    <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># print missing</span>
        <span class="n">t_lo</span><span class="p">,</span> <span class="n">t_hi</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">missing</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">missing</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>  <span class="c1"># bisection with about 1e-9 tolerance</span>
            <span class="n">trial</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_lo</span> <span class="o">+</span> <span class="n">t_hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ptrial</span> <span class="o">=</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="n">ptrial</span> <span class="o">&lt;</span> <span class="n">missing</span>
            <span class="n">t_lo</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
            <span class="n">t_hi</span><span class="p">[</span><span class="o">~</span><span class="n">tidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[</span><span class="o">~</span><span class="n">tidx</span><span class="p">]</span>
        <span class="n">xt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_lo</span> <span class="o">+</span> <span class="n">t_hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># print &quot;err&quot;,np.max(abs(_bspline3(knot,cx,t)-xt))</span>

    <span class="c1"># Return y evaluated at the interpolation points</span>
    <span class="k">return</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">xt</span><span class="p">),</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">xt</span><span class="p">)</span></div>



<div class="viewcode-block" id="bspline">
<a class="viewcode-back" href="../../bumps.bspline.html#bumps.bspline.bspline">[docs]</a>
<span class="k">def</span> <span class="nf">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the B-spline with control points *y* at positions *xt* in [0,1].</span>

<span class="sd">    The spline goes through the control points at the ends.  If *clamp*</span>
<span class="sd">    is True, the derivative of the spline at both ends is zero.  If *clamp*</span>
<span class="sd">    is False, the derivative at the ends is equal to the slope connecting</span>
<span class="sd">    the final pair of control points.</span>

<span class="sd">    B-spline knots are chosen to be equally spaced within [0,1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">xt</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">nderiv</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the B-spline specified by the given *knot* sequence and</span>
<span class="sd">    *control* values at the parametric points *t*.  *nderiv* selects</span>
<span class="sd">    the function or derivative to evaluate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knot</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">knot</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span>

    <span class="c1"># Deal with values outside the range</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">knot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">knot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tv</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">knot</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span><span class="p">[</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">knot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Find B-Spline parameters for the individual segments</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knot</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">knot</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">tv</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">tm2</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">segment</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">tm1</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">segment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">tm0</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">segment</span> <span class="o">-</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
    <span class="n">tp2</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
    <span class="n">tp3</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>

    <span class="n">p4</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>

    <span class="c1"># Compute second and third derivatives.</span>
    <span class="k">if</span> <span class="n">nderiv</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Normally we require a recursion for Q, R and S to compute</span>
        <span class="c1"># df, d2f and d3f respectively, however Q can be computed directly</span>
        <span class="c1"># from intermediate values of P, S has a recursion of depth 0,</span>
        <span class="c1"># which leaves only the R recursion of depth 1 in the calculation</span>
        <span class="c1"># below.</span>
        <span class="n">q4</span> <span class="o">=</span> <span class="p">(</span><span class="n">p4</span> <span class="o">-</span> <span class="n">p3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp3</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm2</span><span class="p">)</span>
        <span class="n">r4</span> <span class="o">=</span> <span class="p">(</span><span class="n">q4</span> <span class="o">-</span> <span class="n">q3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
        <span class="n">r3</span> <span class="o">=</span> <span class="p">(</span><span class="n">q3</span> <span class="o">-</span> <span class="n">q2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nderiv</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">s4</span> <span class="o">=</span> <span class="p">(</span><span class="n">r4</span> <span class="o">-</span> <span class="n">r3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
            <span class="n">d3f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">d3f</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">s4</span>
        <span class="n">r4</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">r3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
        <span class="n">d2f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">d2f</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">r4</span>

    <span class="c1"># Compute function value and first derivative</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span> <span class="o">*</span> <span class="n">p4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp3</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">p3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp3</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p3</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm2</span><span class="p">)</span> <span class="o">*</span> <span class="n">p2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm2</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span> <span class="o">*</span> <span class="n">p4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">p3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p3</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nderiv</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p4</span> <span class="o">-</span> <span class="n">p3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="p">((</span><span class="n">tv</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span> <span class="o">*</span> <span class="n">p4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tv</span><span class="p">)</span> <span class="o">*</span> <span class="n">p3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">p4</span>

    <span class="k">if</span> <span class="n">nderiv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">elif</span> <span class="n">nderiv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">df</span>
    <span class="k">elif</span> <span class="n">nderiv</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">d2f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">d2f</span><span class="p">,</span> <span class="n">d3f</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def bspline_control(y, clamp=True):</span>
<span class="sd">    return _find_control(y, clamp=clamp)</span>


<span class="sd">def pbs_control(x, y, clamp=True):</span>
<span class="sd">    return _find_control(x, clamp=clamp), _find_control(y, clamp=clamp)</span>


<span class="sd">def _find_control(v, clamp=True):</span>
<span class="sd">    raise NotImplementedError(&quot;B-spline interpolation doesn&#39;t work yet&quot;)</span>
<span class="sd">    from scipy.linalg import solve_banded</span>
<span class="sd">    n = len(v)</span>
<span class="sd">    udiag = np.hstack([0, 0, 0, [1 / 6] * (n - 3), 0.25, 0.3])</span>
<span class="sd">    ldiag = np.hstack([-0.3, 0.25, [1 / 6] * (n - 3), 0, 0, 0])</span>
<span class="sd">    mdiag = np.hstack([1, 0.3, 7 / 12, [2 / 3] * (n - 4), 7 / 12, -0.3, 1])</span>
<span class="sd">    A = np.vstack([ldiag, mdiag, udiag])</span>
<span class="sd">    if clamp:</span>
<span class="sd">        # First derivative is zero at ends</span>
<span class="sd">        bl, br = 0, 0</span>
<span class="sd">    else:</span>
<span class="sd">        # First derivative at ends follows line between final control points</span>
<span class="sd">        bl, br = (v[1] - v[0]) * n, (v[-1] - v[-2]) * n</span>
<span class="sd">    b = np.hstack([v[0], bl, v[1:n - 1], br, v[-1]])</span>
<span class="sd">    x = solve_banded((1, 1), A, b)</span>
<span class="sd">    return x  # x[1:-1]</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># ===========================================================================</span>
<span class="c1"># test code</span>

<span class="k">def</span> <span class="nf">speed_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the time to evaluate 400 points on a 7 knot spline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bspline (ms)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that value matches expected within tolerance.</span>

<span class="sd">    If *expected* is never zero, use relative error for tolerance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">relative</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> \
        <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">expected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">expected</span> <span class="o">-</span> <span class="n">got</span><span class="p">)</span> <span class="o">/</span> <span class="n">expected</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">got</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;=</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;expected </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="s2">&quot;got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">got</span><span class="p">),</span>
            <span class="s2">&quot;tol </span><span class="si">%s</span><span class="s2"> norm </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">norm</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_derivs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute numerical derivative for a function evaluated on a fine grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># difference formula</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1"># 5-point difference formula</span>
    <span class="c1">#left = (y[0]-8*y[1]+8*y[3]-y[4]) / 12 / (x[1]-x[0])</span>
    <span class="c1">#right = (y[-5]-8*y[-4]+8*y[-2]-y[-1]) / 12 / (x[-1]-x[-2])</span>
    <span class="c1"># return left, right</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;bspline tests&quot;&quot;&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span>
                   <span class="mi">1</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">xeq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xeq</span> <span class="o">+</span> <span class="mi">0</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span>
                   <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># ==== Check that bspline mat:w</span>
    <span class="c1"># ches pbs with equally spaced x</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xtp</span><span class="p">,</span> <span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xtp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">ytp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xtp</span><span class="p">,</span> <span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xtp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">ytp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xtp</span><span class="p">,</span> <span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xtp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">ytp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xtp</span><span class="p">,</span> <span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xtp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span> <span class="n">ytp</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="c1"># ==== Check bspline f at end points</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-12</span><span class="p">)</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-12</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="c1"># ==== Check f&#39; at end points</span>
    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">left</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">right</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">left</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">right</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">left</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">right</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>

    <span class="c1"># ==== Check interpolator</span>
    <span class="c1">#yc = bspline_control(y)</span>
    <span class="c1"># print(&quot;y&quot;,y)</span>
    <span class="c1"># print(&quot;p(yc)&quot;,bspline(yc,xeq))</span>


<span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show bsline curve for a set of control points.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">subplot</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">show</span>
    <span class="c1">#y = [9 ,6, 1, 3, 8, 4, 2]</span>
    <span class="c1">#y = [9, 11, 13, 3, -2, 0, 2]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1">#y = [9, 9, 1, 3, 8, 2, 2]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="s1">&#39;-.y&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;unclamped bspline&quot;</span><span class="p">)</span>  <span class="c1"># bspline</span>
    <span class="c1"># bspline</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;clamped bspline&quot;</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;:oy&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;control points&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="p">()</span>
    <span class="c1">#left, right = _derivs(t, bspline(y, t, clamp=False))</span>
    <span class="c1">#print(left, (y[1] - y[0]) / (x[1] - x[0]))</span>

    <span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="s1">&#39;-.b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;unclamped pbs&quot;</span><span class="p">)</span>  <span class="c1"># pbs</span>
    <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;clamped pbs&quot;</span><span class="p">)</span>  <span class="c1"># pbs</span>
    <span class="c1">#xt,yt = pbs(x,y,t,clamp=True, parametric=True)</span>
    <span class="c1"># plot(xt,yt,&#39;-g&#39;) # pbs</span>
    <span class="n">plot</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;:ob&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;control points&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="p">()</span>
    <span class="n">show</span><span class="p">()</span>


<span class="c1"># B-Spline control point inverse function is not yet implemented</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def demo_interp():</span>
<span class="sd">    from pylab import linspace, plot, show</span>
<span class="sd">    x = linspace(0, 1, 7)</span>
<span class="sd">    y = [9, 11, 2, 3, 8, 0, 2]</span>
<span class="sd">    t = linspace(0, 1, 400)</span>
<span class="sd">    yc = bspline_control(y, clamp=True)</span>
<span class="sd">    xc = linspace(x[0], x[-1], 9)</span>
<span class="sd">    plot(xc, yc, &#39;:oy&#39;, x, y, &#39;xg&#39;)</span>
<span class="sd">    #knot = np.hstack((0, np.linspace(0,1,len(y)), 1))</span>
<span class="sd">    #fy = _bspline3(knot,yc,t)</span>
<span class="sd">    fy = bspline(yc, t, clamp=True)</span>
<span class="sd">    plot(t, fy, &#39;-.y&#39;)</span>
<span class="sd">    show()</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># test()</span>
    <span class="n">demo</span><span class="p">()</span>
    <span class="c1"># demo_interp()</span>
    <span class="c1"># speed_check()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" >bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.bspline</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>