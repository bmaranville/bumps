<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bumps.wsolve &#8212; Bumps 0.9.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script src="../../_static/documentation_options.js?v=9dc39874"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" accesskey="U">bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.wsolve</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bumps.wsolve</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Weighted linear and polynomial solver with uncertainty.</span>

<span class="sd">Given $A \bar x = \bar y \pm \delta \bar y$, solve using *s = wsolve(A,y,dy)*</span>

<span class="sd">*wsolve* uses the singular value decomposition for increased accuracy.</span>

<span class="sd">The uncertainty in the solution is estimated from the scatter in the data.</span>
<span class="sd">Estimates the uncertainty for the solution from the scatter in the data.</span>

<span class="sd">The returned model object *s* provides:</span>

<span class="sd">    ======== ============================================</span>
<span class="sd">    ======== ============================================</span>
<span class="sd">    s.x      solution</span>
<span class="sd">    s.std    uncertainty estimate assuming no correlation</span>
<span class="sd">    s.rnorm  residual norm</span>
<span class="sd">    s.DoF    degrees of freedom</span>
<span class="sd">    s.cov    covariance matrix</span>
<span class="sd">    s.ci(p)  confidence intervals at point p</span>
<span class="sd">    s.pi(p)  prediction intervals at point p</span>
<span class="sd">    s(p)     predicted value at point p</span>
<span class="sd">    ======== ============================================</span>

<span class="sd">Example</span>
<span class="sd">=======</span>

<span class="sd">Weighted system::</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from bumps import wsolve</span>
<span class="sd">    &gt;&gt;&gt; A = np.array([[1,2,3],[2,1,3],[1,1,1]], dtype=&#39;d&#39;)</span>
<span class="sd">    &gt;&gt;&gt; dy = [0.2,0.01,0.1]</span>
<span class="sd">    &gt;&gt;&gt; y = [ 14.16, 13.01, 6.15]</span>
<span class="sd">    &gt;&gt;&gt; s = wsolve.wsolve(A,y,dy)</span>
<span class="sd">    &gt;&gt;&gt; print(&quot;, &quot;.join(&quot;%0.2f +/- %0.2f&quot;%(a,b) for a,b in zip(s.x,s.std)))</span>
<span class="sd">    1.05 +/- 0.17, 2.20 +/- 0.12, 2.91 +/- 0.12</span>


<span class="sd">Note there is a counter-intuitive result that scaling the estimated</span>
<span class="sd">uncertainty in the data does not affect the computed uncertainty in</span>
<span class="sd">the fit.  This is the correct result --- if the data were indeed</span>
<span class="sd">selected from a process with ten times the uncertainty, you would</span>
<span class="sd">expect the scatter in the data to increase by a factor of ten as</span>
<span class="sd">well.  When this new data set is fitted, it will show a computed</span>
<span class="sd">uncertainty increased by the same factor.  Monte carlo simulations</span>
<span class="sd">bear this out.  The conclusion is that the dataset carries its own</span>
<span class="sd">information about the variance in the data, and the weight vector</span>
<span class="sd">serves only to provide relative weighting between the points.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wsolve&#39;</span><span class="p">,</span> <span class="s1">&#39;wpolyfit&#39;</span><span class="p">,</span> <span class="s1">&#39;LinearModel&#39;</span><span class="p">,</span> <span class="s1">&#39;PolynomialModel&#39;</span><span class="p">]</span>

<span class="c1"># FIXME: test second example</span>
<span class="c1">#</span>
<span class="c1"># Example 2: weighted overdetermined system  y = x1 + 2*x2 + 3*x3 + e</span>
<span class="c1">#</span>
<span class="c1">#    A = fullfact([3,3,3]); xin=[1;2;3];</span>
<span class="c1">#    y = A*xin; dy = rand(size(y))/50; y+=dy.*randn(size(y));</span>
<span class="c1">#    [x,s] = wsolve(A,y,dy);</span>
<span class="c1">#    dx = s.normr*sqrt(sumsq(inv(s.R&#39;))&#39;/s.df);</span>
<span class="c1">#    res = [xin, x, dx]</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="LinearModel">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.LinearModel">[docs]</a>
<span class="k">class</span> <span class="nc">LinearModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model evaluator for linear solution to $Ax = y$.</span>

<span class="sd">    Use *s(A)* to compute the predicted value of the linear model *s*</span>
<span class="sd">    at points given on the rows of $A$.</span>

<span class="sd">    Computes a confidence interval (range of likely values for the</span>
<span class="sd">    mean at $x$) or a prediction interval (range of likely values</span>
<span class="sd">    seen when measuring at $x$).  The prediction interval gives</span>
<span class="sd">    the width of the distribution at $x$.  This should be the same</span>
<span class="sd">    regardless of the number of measurements you have for the value</span>
<span class="sd">    at $x$.  The confidence interval gives the uncertainty in the</span>
<span class="sd">    mean at $x$.  It should get smaller as you increase the number of</span>
<span class="sd">    measurements.  Error bars in the physical sciences usually show</span>
<span class="sd">    a $1-\alpha$ confidence value of $\text{erfc}(1/\sqrt{2})$, representing</span>
<span class="sd">    a $1-\sigma$ standand deviation of uncertainty in the mean.</span>

<span class="sd">    Confidence intervals for the expected value of the linear system</span>
<span class="sd">    evaluated at a new point $w$ are given by the $t$ distribution for</span>
<span class="sd">    the selected interval $1-\alpha$, the solution $x$, and the number</span>
<span class="sd">    of degrees of freedom $n-p$:</span>

<span class="sd">    .. math::</span>

<span class="sd">        w^T x \pm t^{\alpha/2}_{n-p} \sqrt{ \text{var}(w) }</span>

<span class="sd">    where the variance $\text{var}(w)$ is given by:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \text{var}(w) = \sigma^2 (w^T (A^TA)^{-1} w)</span>

<span class="sd">    Prediction intervals are similar, except the variance term increases to</span>
<span class="sd">    include both the uncertainty in the predicted value and the variance in</span>
<span class="sd">    the data:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \text{var}(w) = \sigma^2 (1 + w^T (A^TA)^{-1} w)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DoF</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SVinv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rnorm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Note: SVinv should be computed from S,V where USV&#39; = A</span>
        <span class="c1">#: solution to the equation $Ax = y$</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="c1">#: number of degrees of freedom in the solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DoF</span> <span class="o">=</span> <span class="n">DoF</span>
        <span class="c1">#: 2-norm of the residuals $||y-Ax||_2$</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnorm</span> <span class="o">=</span> <span class="n">rnorm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SVinv</span> <span class="o">=</span> <span class="n">SVinv</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the prediction for a linear system at points in the rows of A.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># covariance matrix invC = A&#39;A  = (USV&#39;)&#39;USV&#39; = VSU&#39;USV&#39; = VSSV&#39;</span>
    <span class="c1"># C = inv(A&#39;A) = inv(VSSV&#39;) = inv(V&#39;)inv(SS)inv(V) = Vinv(SS)V&#39;</span>
    <span class="c1"># diag(inv(A&#39;A)) is sum of the squares of the columns inv(S) V&#39;</span>
    <span class="c1"># and is also the sum of the squares of the rows of V inv(S)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;covariance matrix [inv(A&#39;A); O(n^3)]&quot;&quot;&quot;</span>
        <span class="c1"># FIXME: don&#39;t know if we need to scale by C, but it will</span>
        <span class="c1"># at least make things consistent</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnorm</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">DoF</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DoF</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SVinv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SVinv</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;solution variance [diag(cov); O(n^2)]&quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnorm</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">DoF</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DoF</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SVinv</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;solution standard deviation [sqrt(var); O(n^2)]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;p-value probability of rejection&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>  <span class="c1"># lazy import in case scipy not present</span>
        <span class="k">return</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnorm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DoF</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper for computing prediction/confidence intervals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Comments from QR decomposition solution to Ax = y:</span>
        <span class="c1">#</span>
        <span class="c1">#   Rather than A&#39;A we have R from the QR decomposition of A, but</span>
        <span class="c1">#   R&#39;R equals A&#39;A.  Note that R is not upper triangular since we</span>
        <span class="c1">#   have already multiplied it by the permutation matrix, but it</span>
        <span class="c1">#   is invertible.  Rather than forming the product R&#39;R which is</span>
        <span class="c1">#   ill-conditioned, we can rewrite x&#39; inv(A&#39;A) x as the equivalent</span>
        <span class="c1">#      x&#39; inv(R) inv(R&#39;) x = t t&#39;, for t = x&#39; inv(R)</span>
        <span class="c1">#</span>
        <span class="c1"># We have since switched to an SVD solver, which gives us</span>
        <span class="c1">#</span>
        <span class="c1">#    invC = A&#39; A  = (USV&#39;)&#39; USV&#39; = VSU&#39; USV&#39; = V S S V&#39;</span>
        <span class="c1">#    C = inv(A&#39;A) = inv(VSSV&#39;) = inv(V&#39;) inv(S S) inv(V)</span>
        <span class="c1">#      = V inv(S S) V&#39; = V inv(S) inv(S) V&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># Substituting, we get</span>
        <span class="c1">#</span>
        <span class="c1">#    x&#39; inv(A&#39;A) x = t t&#39;, for t = x&#39; V inv(S)</span>
        <span class="c1">#</span>
        <span class="c1"># Since x is a vector, t t&#39; is the inner product sum(t**2).</span>
        <span class="c1"># Note that LAPACK allows us to do this simultaneously for many</span>
        <span class="c1"># different x using sqrt(sum(T**2,axis=1)), with T = X&#39; Vinv(S).</span>
        <span class="c1">#</span>
        <span class="c1"># Note: sqrt(F(1-a;1,df)) = T(1-a/2;df)</span>
        <span class="c1">#</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>  <span class="c1"># lazy import in case scipy not present</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DoF</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnorm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DoF</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SVinv</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span>

<div class="viewcode-block" id="LinearModel.ci">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.LinearModel.ci">[docs]</a>
    <span class="k">def</span> <span class="nf">ci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the calculated values and the confidence intervals</span>
<span class="sd">        for the linear model evaluated at $A$.</span>

<span class="sd">        *sigma=1* corresponds to a $1-\sigma$ confidence interval</span>

<span class="sd">        Confidence intervals are sometimes expressed as $1-\alpha$ values,</span>
<span class="sd">        where $\alpha = \text{erfc}(\sigma/\sqrt{2})$.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erfc</span>  <span class="c1"># lazy import in case scipy not present</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">erfc</span><span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LinearModel.pi">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.LinearModel.pi">[docs]</a>
    <span class="k">def</span> <span class="nf">pi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the calculated values and the prediction intervals</span>
<span class="sd">        for the linear model evaluated at $A$.</span>

<span class="sd">        *p=0.05* corresponds to the 95% prediction interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="wsolve">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.wsolve">[docs]</a>
<span class="k">def</span> <span class="nf">wsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a linear system $y = A x + \delta y$, estimates $x$ and $\delta x$.</span>

<span class="sd">    *A* is an n x m array of measurement points.</span>

<span class="sd">    *y* is an n x k array or vector of length n of measured values at *A*.</span>

<span class="sd">    *dy* is a scalar or an n x 1 array of uncertainties in the values at *A*.</span>

<span class="sd">    Returns :class:`LinearModel`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The ugliness v[:, N.newaxis] transposes a vector</span>
    <span class="c1"># The ugliness N.dot(a, b) is a*b for a,b matrices</span>
    <span class="c1"># The ugliness vh.T.conj() is the hermitian transpose</span>

    <span class="c1"># Make sure inputs are arrays</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># Apply weighting if dy is not a scalar</span>
    <span class="c1"># If dy is a scalar, it cancels out of both sides of the equation</span>
    <span class="c1"># Note: with A,dy arrays instead of matrices, A/dy operates element-wise</span>
    <span class="c1"># Since dy is a row vector, this divides each row of A by the corresponding</span>
    <span class="c1"># element of dy.</span>
    <span class="k">if</span> <span class="n">dy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="n">dy</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">dy</span>

    <span class="c1"># Singular value decomposition: A = U S V.H</span>
    <span class="c1"># Since A is an array, U, S, VH are also arrays</span>
    <span class="c1"># The zero indicates an economy decomposition, with u nxm rathern than nxn</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># FIXME what to do with ill-conditioned systems?</span>
    <span class="c1"># Use regularization? L1 (Lasso), L2 (Ridge) or both (Elastic Net)</span>
    <span class="c1">#if s[-1]&lt;rcond*s[0]: raise ValueError, &quot;matrix is singular&quot;</span>
    <span class="c1"># s[s&lt;rcond*s[0]] = 0.  # Can&#39;t do this because 1/s below will fail</span>

    <span class="c1"># Solve: x = V inv(S) U.H y</span>
    <span class="c1"># S diagonal elements =&gt; 1/S is inv(S)</span>
    <span class="c1"># A*D, D diagonal multiplies each column of A by the corresponding diagonal</span>
    <span class="c1"># D*A, D diagonal multiplies each row of A by the corresponding diagonal</span>
    <span class="c1"># Computing V*inv(S) is slightly faster than inv(S)*U.H since V is smaller</span>
    <span class="c1"># than U.H.  Similarly, U.H*y is somewhat faster than V*U.H</span>
    <span class="n">SVinv</span> <span class="o">=</span> <span class="n">vh</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">Uy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">SVinv</span><span class="p">,</span> <span class="n">Uy</span><span class="p">)</span>

    <span class="n">DoF</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">LinearModel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">DoF</span><span class="o">=</span><span class="n">DoF</span><span class="p">,</span> <span class="n">SVinv</span><span class="o">=</span><span class="n">SVinv</span><span class="p">,</span> <span class="n">rnorm</span><span class="o">=</span><span class="n">rnorm</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_poly_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the matrix A used to fit a polynomial using a linear solver.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">**</span> <span class="n">n</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>


<div class="viewcode-block" id="PolynomialModel">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.PolynomialModel">[docs]</a>
<span class="k">class</span> <span class="nc">PolynomialModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model evaluator for best fit polynomial $p(x) = y +/- \delta y$.</span>

<span class="sd">    Use *p(x)* for PolynomialModel *p* to evaluate the polynomial at all</span>
<span class="sd">    points in the vector *x*.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">)]</span>
        <span class="c1">#: True if polynomial goes through the origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="c1">#: polynomial coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1">#: polynomial degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">#: number of degrees of freedom in the solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DoF</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">DoF</span>
        <span class="c1">#: 2-norm of the residuals $||y-Ax||_2$</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnorm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rnorm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        covariance matrix</span>

<span class="sd">        Note that the ones column will be absent if *origin* is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">cov</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;solution variance&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">var</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;solution standard deviation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">std</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;p-value probability of rejection&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">p</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the polynomial at x.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<div class="viewcode-block" id="PolynomialModel.der">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.PolynomialModel.der">[docs]</a>
    <span class="k">def</span> <span class="nf">der</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the polynomial derivative at x.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolynomialModel.ci">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.PolynomialModel.ci">[docs]</a>
    <span class="k">def</span> <span class="nf">ci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the polynomial and the confidence intervals at x.</span>

<span class="sd">        sigma=1 corresponds to a 1-sigma confidence interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">_poly_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">ci</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolynomialModel.pi">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.PolynomialModel.pi">[docs]</a>
    <span class="k">def</span> <span class="nf">pi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the polynomial and the prediction intervals at x.</span>

<span class="sd">        p = 1-alpha = 0.05 corresponds to 95% prediction interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">_poly_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">pi</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: better polynomial pretty printing using formatnum</span>
        <span class="k">return</span> <span class="s2">&quot;Polynomial(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span>


<div class="viewcode-block" id="PolynomialModel.plot">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.PolynomialModel.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_x</span><span class="o">-</span><span class="n">padding</span><span class="p">,</span> <span class="n">max_x</span><span class="o">+</span><span class="n">padding</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;b.&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ci</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">cdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">cdy</span><span class="p">,</span> <span class="s1">&#39;b-.&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">cdy</span><span class="p">,</span> <span class="s1">&#39;b-.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">pdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">pdy</span><span class="p">,</span> <span class="s1">&#39;b-.&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">pdy</span><span class="p">,</span> <span class="s1">&#39;b-.&#39;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="wpolyfit">
<a class="viewcode-back" href="../../bumps.wsolve.html#bumps.wsolve.wpolyfit">[docs]</a>
<span class="k">def</span> <span class="nf">wpolyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the polynomial of degree $n$ that minimizes $\sum(p(x_i) - y_i)^2/\sigma_i^2$.</span>

<span class="sd">    if origin is True, the fit should go through the origin.</span>

<span class="sd">    Returns :class:`PolynomialModel`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">degree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing degree argument to wpolyfit&quot;</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">_poly_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">wsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PolynomialModel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a random cubic polynomial.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pylab</span>

    <span class="c1"># Make fake data</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="mf">.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># polynomial</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">th</span><span class="p">))</span>        <span class="c1"># poisson uncertainty estimate</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>    <span class="c1"># but normal generator</span>

    <span class="c1"># Fit to a polynomial</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">wpolyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">poly</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">demo2</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">pylab</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.2</span><span class="p">,</span> <span class="mf">7.9</span><span class="p">,</span> <span class="mf">6.9</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">wpolyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">poly</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that results are correct for a known problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_array_almost_equal_nulp</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">7.9</span><span class="p">,</span> <span class="mf">13.9</span><span class="p">,</span> <span class="mf">21.1</span><span class="p">,</span> <span class="mf">44.4</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">4.8</span><span class="p">,</span> <span class="mf">6.2</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">wpolyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">pi</span><span class="p">(</span><span class="n">px</span><span class="p">)</span>  <span class="c1"># Same y is returend from pi and ci</span>
    <span class="n">py</span><span class="p">,</span> <span class="n">ci</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">ci</span><span class="p">(</span><span class="n">px</span><span class="p">)</span>

    <span class="c1"># Uncomment these to show target values</span>
    <span class="c1"># print &quot;Tp = [%.16g, %.16g]&quot;%(p[0],p[1])</span>
    <span class="c1"># print &quot;Tdp = [%.16g, %.16g]&quot;%(dp[0],dp[1])</span>
    <span class="c1"># print &quot;Tpi,Tci = %.16g, %.16g&quot;%(pi,ci)</span>
    <span class="n">Tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">7.787249069840737</span><span class="p">,</span> <span class="mf">1.503992847461524</span><span class="p">])</span>
    <span class="n">Tdp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.522338103010216</span><span class="p">,</span> <span class="mf">2.117633626902384</span><span class="p">])</span>
    <span class="n">Tpi</span><span class="p">,</span> <span class="n">Tci</span> <span class="o">=</span> <span class="mf">7.611128464981324</span><span class="p">,</span> <span class="mf">2.342860389884832</span>

    <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">coeff</span> <span class="o">-</span> <span class="n">Tp</span><span class="p">))</span>
    <span class="n">dperr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">std</span> <span class="o">-</span> <span class="n">Tdp</span><span class="p">))</span>
    <span class="n">cierr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ci</span> <span class="o">-</span> <span class="n">Tci</span><span class="p">)</span>
    <span class="n">pierr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pi</span> <span class="o">-</span> <span class="n">Tpi</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">perr</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="s2">&quot;||p-Tp||=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">perr</span>
    <span class="k">assert</span> <span class="n">dperr</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="s2">&quot;||dp-Tdp||=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dperr</span>
    <span class="k">assert</span> <span class="n">cierr</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="s2">&quot;||ci-Tci||=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cierr</span>
    <span class="k">assert</span> <span class="n">pierr</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="s2">&quot;||pi-Tpi||=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pierr</span>
    <span class="n">assert_array_almost_equal_nulp</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="n">poly</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">nulp</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1">#test()</span>
    <span class="n">demo</span><span class="p">()</span>
    <span class="c1">#demo2()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" >bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.wsolve</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>