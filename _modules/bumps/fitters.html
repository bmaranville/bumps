<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bumps.fitters &#8212; Bumps 0.9.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script src="../../_static/documentation_options.js?v=9dc39874"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" accesskey="U">bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.fitters</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bumps.fitters</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Interfaces to various optimizers.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># CRUFT: time.clock() removed from python 3.8</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">clock</span> <span class="k">as</span> <span class="n">perf_counter</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">monitor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">initpop</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lsqerror</span>

<span class="kn">from</span> <span class="nn">.history</span> <span class="kn">import</span> <span class="n">History</span>
<span class="kn">from</span> <span class="nn">.formatnum</span> <span class="kn">import</span> <span class="n">format_uncertainty</span>
<span class="kn">from</span> <span class="nn">.fitproblem</span> <span class="kn">import</span> <span class="n">nllf_scale</span>

<span class="kn">from</span> <span class="nn">.dream</span> <span class="kn">import</span> <span class="n">MCMCModel</span>


<div class="viewcode-block" id="ConsoleMonitor">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.ConsoleMonitor">[docs]</a>
<span class="k">class</span> <span class="nc">ConsoleMonitor</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">TimedUpdate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display fit progress on the console</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">improvement</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">TimedUpdate</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                                     <span class="n">improvement</span><span class="o">=</span><span class="n">improvement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>

<div class="viewcode-block" id="ConsoleMonitor.show_progress">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.ConsoleMonitor.show_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">show_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="n">scale</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">nllf_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="n">format_uncertainty</span><span class="p">(</span><span class="n">scale</span><span class="o">*</span><span class="n">history</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">err</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;cost&quot;</span><span class="p">,</span> <span class="n">chisq</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="ConsoleMonitor.show_improvement">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.ConsoleMonitor.show_improvement">[docs]</a>
    <span class="k">def</span> <span class="nf">show_improvement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="c1"># print(&quot;step&quot;,history.step[0],&quot;chisq&quot;,history.value[0])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">summarize</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="CheckpointMonitor">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.CheckpointMonitor">[docs]</a>
<span class="k">class</span> <span class="nc">CheckpointMonitor</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">TimedUpdate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Periodically save fit state so that it can be resumed later.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Function to call at each checkpoint.</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Callable[None, None]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">TimedUpdate</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                                     <span class="n">improvement</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CheckpointMonitor.show_progress">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.CheckpointMonitor.show_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">show_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="c1"># Skip the first checkpoint since it only contains the</span>
        <span class="c1"># start/resume state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">history</span><span class="p">)</span></div>


<div class="viewcode-block" id="CheckpointMonitor.show_improvement">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.CheckpointMonitor.show_improvement">[docs]</a>
    <span class="k">def</span> <span class="nf">show_improvement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="StepMonitor">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.StepMonitor">[docs]</a>
<span class="k">class</span> <span class="nc">StepMonitor</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">Monitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect information at every step of the fit and save it to a file.</span>

<span class="sd">    *fid* is the file to save the information to</span>
<span class="sd">    *fields* is the list of &quot;step|time|value|point&quot; fields to save</span>

<span class="sd">    The point field should be last in the list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">FIELDS</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid monitor field&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;)s %(&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="StepMonitor.config_history">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.StepMonitor.config_history">[docs]</a>
    <span class="k">def</span> <span class="nf">config_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="n">history</span><span class="o">.</span><span class="n">requires</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.15g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">history</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">history</span><span class="o">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scale</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nllf_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.15g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">history</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">point</span><span class="o">=</span><span class="n">point</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="MonitorRunner">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.MonitorRunner">[docs]</a>
<span class="k">class</span> <span class="nc">MonitorRunner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptor which allows solvers to accept progress monitors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">monitors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConsoleMonitor</span><span class="p">(</span><span class="n">problem</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="n">monitors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">population_points</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
            <span class="n">M</span><span class="o">.</span><span class="n">config_history</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                 <span class="n">population_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">,</span>
                            <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">point</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">population_points</span><span class="o">=</span><span class="n">population_points</span><span class="p">,</span>
                            <span class="n">population_values</span><span class="o">=</span><span class="n">population_values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
            <span class="n">M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span></div>



<div class="viewcode-block" id="FitBase">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitBase">[docs]</a>
<span class="k">class</span> <span class="nc">FitBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FitBase defines the interface from bumps models to the various fitting</span>
<span class="sd">    engines available within bumps.</span>

<span class="sd">    Each engine is defined in its own class with a specific set of attributes</span>
<span class="sd">    and methods.</span>

<span class="sd">    The *name* attribute is the name of the optimizer.  This is just a simple</span>
<span class="sd">    string.</span>

<span class="sd">    The *settings* attribute is a list of pairs (name, default), where the</span>
<span class="sd">    names are defined as fields in FitOptions.  A best attempt should be</span>
<span class="sd">    made to map the fit options for the optimizer to the standard fit options,</span>
<span class="sd">    since each of these becomes a new command line option when running</span>
<span class="sd">    bumps.  If that is not possible, then a new option should be added</span>
<span class="sd">    to FitOptions.  A plugin architecture might be appropriate here, if</span>
<span class="sd">    there are reasons why specific problem domains might need custom fitters,</span>
<span class="sd">    but this is not yet supported.</span>

<span class="sd">    Each engine takes a fit problem in its constructor.</span>

<span class="sd">    The :meth:`solve` method runs the fit.  It accepts a</span>
<span class="sd">    monitor to track updates, a mapper to distribute work and</span>
<span class="sd">    key-value pairs defining the settings.</span>

<span class="sd">    There are a number of optional methods for the fitting engines.  Basically,</span>
<span class="sd">    all the methods in :class:`FitDriver` first check if they are specialized</span>
<span class="sd">    in the fit engine before performing a default action.</span>

<span class="sd">    The *load*/*save* methods load and save the fitter state in a given</span>
<span class="sd">    directory with a specific base file name.  The fitter can choose a file</span>
<span class="sd">    extension to add to the base name.  Some care is needed to be sure that</span>
<span class="sd">    the extension doesn&#39;t collide with other extensions such as .mon for</span>
<span class="sd">    the fit monitor.</span>

<span class="sd">    The *plot* method shows any plots to help understand the performance of</span>
<span class="sd">    the fitter, such as a convergence plot showing the the range of values</span>
<span class="sd">    in the population over time, as well as plots of the parameter uncertainty</span>
<span class="sd">    if available.  The plot should work within  is given a figure canvas to work with</span>

<span class="sd">    The *stderr*/*cov* methods should provide summary statistics for the</span>
<span class="sd">    parameter uncertainties.  Some fitters, such as MCMC, will compute these</span>
<span class="sd">    directly from the population.  Others, such as BFGS, will produce an</span>
<span class="sd">    estimate of the uncertainty as they go along.  If the fitter does not</span>
<span class="sd">    provide these estimates, then they will be computed from numerical</span>
<span class="sd">    derivatives at the minimum in the FitDriver method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the models and show the results&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>

<div class="viewcode-block" id="FitBase.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitBase.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="MultiStart">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.MultiStart">[docs]</a>
<span class="k">class</span> <span class="nc">MultiStart</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-start monte carlo fitter.</span>

<span class="sd">    This fitter wraps a local optimizer, restarting it a number of times</span>
<span class="sd">    to give it a chance to find a different local minimum.  If the keep_best</span>
<span class="sd">    option is True, then restart near the best fit, otherwise restart at</span>
<span class="sd">    random.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Multistart Monte Carlo&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitter</span><span class="p">):</span>
        <span class="n">FitBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitter</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitter</span>

<div class="viewcode-block" id="MultiStart.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.MultiStart.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="c1"># TODO: need better way of tracking progress</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keep_best&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">f_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">x_best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;multistart round </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fx</span> <span class="o">&lt;</span> <span class="n">f_best</span><span class="p">:</span>
                <span class="n">x_best</span><span class="p">,</span> <span class="n">f_best</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;multistart f(x),x: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fx</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_best</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">randomize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Jitter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">x_best</span><span class="p">)</span>
                <span class="n">pop</span> <span class="o">=</span> <span class="n">initpop</span><span class="o">.</span><span class="n">eps_init</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">(),</span>
                                       <span class="n">use_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">pop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">x_best</span><span class="p">,</span> <span class="n">f_best</span></div>
</div>



<div class="viewcode-block" id="DEFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DEFit">[docs]</a>
<span class="k">class</span> <span class="nc">DEFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classic Storn and Price differential evolution optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Differential Evolution&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;de&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CR&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;xtol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="c1">#(&#39;stop&#39;, &#39;&#39;),</span>
               <span class="p">]</span>

<div class="viewcode-block" id="DEFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DEFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.mystic.optimizer</span> <span class="kn">import</span> <span class="n">de</span>
        <span class="kn">from</span> <span class="nn">.mystic.solver</span> <span class="kn">import</span> <span class="n">Minimizer</span>
        <span class="kn">from</span> <span class="nn">.mystic</span> <span class="kn">import</span> <span class="n">stop</span>
        <span class="k">if</span> <span class="n">monitors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">monitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConsoleMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_mapper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">mapper</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_mapper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">resume</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">resume</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">de</span><span class="o">.</span><span class="n">DifferentialEvolution</span><span class="p">(</span><span class="n">npop</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;pop&#39;</span><span class="p">],</span>
                                            <span class="n">CR</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;CR&#39;</span><span class="p">],</span>
                                            <span class="n">F</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">],</span>
                                            <span class="n">crossover</span><span class="o">=</span><span class="n">de</span><span class="o">.</span><span class="n">c_bin</span><span class="p">,</span>
                                            <span class="n">mutate</span><span class="o">=</span><span class="n">de</span><span class="o">.</span><span class="n">rand1u</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">parse_tolerance</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">failure</span> <span class="o">=</span> <span class="n">stop</span><span class="o">.</span><span class="n">Steps</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
        <span class="c1"># Step adds to current step number if resume</span>
        <span class="n">minimize</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span> <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                             <span class="n">history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">failure</span><span class="o">=</span><span class="n">failure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resume</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="n">_mapper</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="n">abort_test</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">)</span>
        <span class="c1">#print(minimize.termination_condition())</span>
        <span class="c1">#with open(&quot;/tmp/evals&quot;,&quot;a&quot;) as fid:</span>
        <span class="c1">#   print &gt;&gt;fid,minimize.history.value[0],minimize.history.step[0],\</span>
        <span class="c1">#       minimize.history.step[0]*options[&#39;pop&#39;]*len(self.problem.getp())</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="DEFit.load">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DEFit.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">load_history</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="DEFit.save">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DEFit.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="n">save_history</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">snapshot</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="parse_tolerance">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.parse_tolerance">[docs]</a>
<span class="k">def</span> <span class="nf">parse_tolerance</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.mystic</span> <span class="kn">import</span> <span class="n">stop</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">stop</span><span class="o">.</span><span class="n">parse_condition</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">])</span>

    <span class="n">xtol</span><span class="p">,</span> <span class="n">ftol</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;xtol&#39;</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">xtol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ftol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ftol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stop</span><span class="o">.</span><span class="n">Rf</span><span class="p">(</span><span class="o">-</span><span class="n">ftol</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stop</span><span class="o">.</span><span class="n">Rf</span><span class="p">(</span><span class="n">ftol</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xtol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">xtol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stop</span><span class="o">.</span><span class="n">Rx</span><span class="p">(</span><span class="o">-</span><span class="n">xtol</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stop</span><span class="o">.</span><span class="n">Rx</span><span class="p">(</span><span class="n">xtol</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_history_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;-history.json&quot;</span>


<div class="viewcode-block" id="load_history">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.load_history">[docs]</a>
<span class="k">def</span> <span class="nf">load_history</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load fitter details from a history file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_history_file</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_history">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.save_history">[docs]</a>
<span class="k">def</span> <span class="nf">save_history</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save fitter details to a history file as JSON.</span>

<span class="sd">    The content of the details are fitter specific.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_history_file</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span></div>



<div class="viewcode-block" id="BFGSFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.BFGSFit">[docs]</a>
<span class="k">class</span> <span class="nc">BFGSFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    BFGS quasi-newton optimizer.</span>

<span class="sd">    BFGS estimates Hessian and its Cholesky decomposition, but initial</span>
<span class="sd">    tests give uncertainties quite different from the directly computed</span>
<span class="sd">    Jacobian in Levenburg-Marquardt or the Hessian estimated at the</span>
<span class="sd">    minimum by numerical differentiation.</span>

<span class="sd">    To use the internal &#39;H&#39; and &#39;L&#39; and save some computation time, then</span>
<span class="sd">    use::</span>

<span class="sd">        C = lsqerror.chol_cov(fit.result[&#39;L&#39;])</span>
<span class="sd">        stderr = lsqerror.stderr(C)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Quasi-Newton BFGS&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;newton&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;xtol&#39;</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)]</span>

<div class="viewcode-block" id="BFGSFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.BFGSFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.quasinewton</span> <span class="kn">import</span> <span class="n">quasinewton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">quasinewton</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span>
                             <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                             <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">,</span>
                             <span class="n">abort_test</span><span class="o">=</span><span class="n">abort_test</span><span class="p">,</span>
                             <span class="n">itnlimit</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">],</span>
                             <span class="n">gradtol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">],</span>
                             <span class="n">steptol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                             <span class="n">macheps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                             <span class="n">eta</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="c1">#code = result[&#39;status&#39;]</span>
        <span class="c1">#from .quasinewton import STATUS</span>
        <span class="c1">#print(&quot;%d: %s, x=%s, fx=%s&quot;</span>
        <span class="c1">#      % (code, STATUS[code], result[&#39;x&#39;], result[&#39;fx&#39;]))</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fx&#39;</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">fx</span><span class="p">,</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                     <span class="n">population_values</span><span class="o">=</span><span class="p">[</span><span class="n">fx</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="PSFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.PSFit">[docs]</a>
<span class="k">class</span> <span class="nc">PSFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Particle swarm optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Particle Swarm&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;ps&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

<div class="viewcode-block" id="PSFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.PSFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">.random_lines</span> <span class="kn">import</span> <span class="n">particle_swarm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
        <span class="n">cfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parallel_cost</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
                   <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">low</span><span class="p">),</span>
                   <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                   <span class="n">x1</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
                   <span class="n">x2</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
                   <span class="n">f_opt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">)</span>
        <span class="n">npop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfo</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;pop&#39;</span><span class="p">])</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">particle_swarm</span><span class="p">(</span><span class="n">cfo</span><span class="p">,</span> <span class="n">npop</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">])</span>
        <span class="n">satisfied_sc</span><span class="p">,</span> <span class="n">n_feval</span><span class="p">,</span> <span class="n">f_best</span><span class="p">,</span> <span class="n">x_best</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">x_best</span><span class="p">,</span> <span class="n">f_best</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">fx</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=</span><span class="n">fx</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="RLFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.RLFit">[docs]</a>
<span class="k">class</span> <span class="nc">RLFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Random lines optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Random Lines&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;rl&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CR&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)]</span>

<div class="viewcode-block" id="RLFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.RLFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">.random_lines</span> <span class="kn">import</span> <span class="n">random_lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
        <span class="n">cfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parallel_cost</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
                   <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">low</span><span class="p">),</span>
                   <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                   <span class="n">x1</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
                   <span class="n">x2</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
                   <span class="n">f_opt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">)</span>
        <span class="n">npop</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cfo</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;pop&#39;</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">random_lines</span><span class="p">(</span><span class="n">cfo</span><span class="p">,</span> <span class="n">npop</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="n">abort_test</span><span class="p">,</span>
                              <span class="n">maxiter</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">],</span> <span class="n">CR</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;CR&#39;</span><span class="p">])</span>
        <span class="n">satisfied_sc</span><span class="p">,</span> <span class="n">n_feval</span><span class="p">,</span> <span class="n">f_best</span><span class="p">,</span> <span class="n">x_best</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">x_best</span><span class="p">,</span> <span class="n">f_best</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="c1"># print &quot;rl best&quot;,k, x.shape,fx.shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">fx</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=</span><span class="n">fx</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="PTFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.PTFit">[docs]</a>
<span class="k">class</span> <span class="nc">PTFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel tempering optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Parallel Tempering&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;pt&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;nT&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CR&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;burn&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Tmin&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Tmax&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>

<div class="viewcode-block" id="PTFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.PTFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="c1"># TODO: no mapper??</span>
        <span class="kn">from</span> <span class="nn">.partemp</span> <span class="kn">import</span> <span class="n">parallel_tempering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;Tmin&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;Tmax&#39;</span><span class="p">]),</span>
                        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;nT&#39;</span><span class="p">])</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">parallel_tempering</span><span class="p">(</span><span class="n">nllf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span>
                                     <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                                     <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">(),</span>
                                     <span class="c1"># logfile=&quot;partemp.dat&quot;,</span>
                                     <span class="n">T</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                                     <span class="n">CR</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;CR&#39;</span><span class="p">],</span>
                                     <span class="n">steps</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">],</span>
                                     <span class="n">burn</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;burn&#39;</span><span class="p">],</span>
                                     <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">best_point</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">best</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">fx</span><span class="p">,</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=</span><span class="n">E</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="SimplexFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.SimplexFit">[docs]</a>
<span class="k">class</span> <span class="nc">SimplexFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Nelder-Mead simplex optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Nelder-Mead Simplex&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;amoeba&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;xtol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)]</span>

<div class="viewcode-block" id="SimplexFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.SimplexFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.simplex</span> <span class="kn">import</span> <span class="n">simplex</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="c1"># TODO: no mapper??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="c1">#print(&quot;bounds&quot;, self.problem.bounds())</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">simplex</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                         <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">(),</span>
                         <span class="n">abort_test</span><span class="o">=</span><span class="n">abort_test</span><span class="p">,</span>
                         <span class="n">update_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">,</span>
                         <span class="n">maxiter</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">],</span>
                         <span class="n">radius</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span>
                         <span class="n">xtol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;xtol&#39;</span><span class="p">],</span>
                         <span class="n">ftol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">])</span>
        <span class="c1"># Let simplex propose the starting point for the next amoeba</span>
        <span class="c1"># fit in a multistart amoeba context.  If the best is always</span>
        <span class="c1"># used, the fit can get stuck in a local minimum.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">next_start</span><span class="p">)</span>
        <span class="c1">#print(&quot;amoeba %s %s&quot;%(result.x,result.fx))</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">fx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=</span><span class="n">fx</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="MPFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.MPFit">[docs]</a>
<span class="k">class</span> <span class="nc">MPFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MPFit optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Levenberg-Marquardt&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;lm&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;xtol&#39;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)]</span>

<div class="viewcode-block" id="MPFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.MPFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.mpfit</span> <span class="kn">import</span> <span class="n">mpfit</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span> <span class="o">=</span> <span class="n">abort_test</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span>
        <span class="n">parinfo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()):</span>
            <span class="n">parinfo</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="c1">#&#39;value&#39;: None,  # passed in by xall instead</span>
                <span class="c1">#&#39;fixed&#39;: False,  # everything is varying</span>
                <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">low</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">high</span><span class="p">)),</span>
                <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">),</span>
                <span class="c1">#&#39;parname&#39;: &#39;&#39;,  # could probably ask problem for this...</span>
                <span class="c1"># From the code, default step size is sqrt(eps)*abs(value)</span>
                <span class="c1"># or eps if value is 0.  This seems okay.  The other</span>
                <span class="c1"># other alternative is to limit it by bounds.</span>
                <span class="c1">#&#39;step&#39;: 0,  # compute step automatically</span>
                <span class="c1">#&#39;mpside&#39;: 0,  # 1, -1 or 2 for right-, left- or 2-sided deriv</span>
                <span class="c1">#&#39;mpmaxstep&#39;: 0.,  # max step for this parameter</span>
                <span class="c1">#&#39;tied&#39;: &#39;&#39;,  # parameter expressions tying fit parameters</span>
                <span class="c1">#&#39;mpprint&#39;: 1,  # print the parameter value when iterating</span>
            <span class="p">})</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">mpfit</span><span class="p">(</span>
            <span class="n">fcn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">,</span>
            <span class="n">xall</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span>
            <span class="n">parinfo</span><span class="o">=</span><span class="n">parinfo</span><span class="p">,</span>
            <span class="n">autoderivative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fastnorm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">double</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># use single precision machine epsilon for derivative step</span>
            <span class="c1">#damp=0,  # no damping when damp=0</span>
            <span class="c1"># Stopping conditions</span>
            <span class="n">ftol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">],</span>
            <span class="n">xtol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;xtol&#39;</span><span class="p">],</span>
            <span class="c1">#gtol=1e-100, # exclude gtol test</span>
            <span class="n">maxiter</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">],</span>
            <span class="c1"># Progress monitor</span>
            <span class="n">iterfunct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">,</span>
            <span class="n">nprint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># call monitor each iteration</span>
            <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># leave it to monitor to print any info</span>
            <span class="c1"># Returns values</span>
            <span class="n">nocovar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># use our own covar calculation for consistency</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">fnorm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span></div>



    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcn</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fnorm</span><span class="p">,</span>
                 <span class="n">functkw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">fnorm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">fjac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">():</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1"># treat prior probabilities on the parameters as additional</span>
        <span class="c1"># measurements</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">residuals</span><span class="p">()</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameter_residuals</span><span class="p">()))</span>
        <span class="c1"># Tally costs for broken constraints</span>
        <span class="n">extra_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">constraints_nllf</span><span class="p">()</span>
        <span class="c1"># Spread the cost over the residuals.  Since we are smoothly increasing</span>
        <span class="c1"># residuals as we leave the boundary, this should push us back into the</span>
        <span class="c1"># boundary (within tolerance) during the lm fit.</span>
        <span class="n">residuals</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">extra_cost</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">residuals</span></div>



<div class="viewcode-block" id="LevenbergMarquardtFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.LevenbergMarquardtFit">[docs]</a>
<span class="k">class</span> <span class="nc">LevenbergMarquardtFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Levenberg-Marquardt optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Levenberg-Marquardt (scipy.leastsq)&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;scipy.leastsq&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1.5e-8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;xtol&#39;</span><span class="p">,</span> <span class="mf">1.5e-8</span><span class="p">)]</span>
    <span class="c1"># LM also has</span>
    <span class="c1">#    gtol: orthoganality between jacobian columns</span>
    <span class="c1">#    epsfcn: numerical derivative step size</span>
    <span class="c1">#    factor: initial radius</span>
    <span class="c1">#    diag: variable scale factors to bring them near 1</span>

<div class="viewcode-block" id="LevenbergMarquardtFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.LevenbergMarquardtFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span>
        <span class="n">maxfev</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounded_residuals</span><span class="p">,</span>
                                  <span class="n">x0</span><span class="p">,</span>
                                  <span class="n">ftol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">],</span>
                                  <span class="n">xtol</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;xtol&#39;</span><span class="p">],</span>
                                  <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">,</span>
                                  <span class="n">epsfcn</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                                  <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">cov_x</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">success</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># don&#39;t treat &quot;reached maxfev&quot; as a true failure</span>
            <span class="k">if</span> <span class="s2">&quot;reached maxfev&quot;</span> <span class="ow">in</span> <span class="n">mesg</span><span class="p">:</span>
                <span class="c1"># unless the x values are bad</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">mesg</span> <span class="o">=</span> <span class="s2">&quot;Levenberg-Marquardt fit failed with bad values&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="n">cov_x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># compute one last time with x forced inside the boundary, and using</span>
        <span class="c1"># problem.nllf as returned by other optimizers.  We will ignore the</span>
        <span class="c1"># covariance output and calculate it again ourselves.  Not ideal if</span>
        <span class="c1"># f is expensive, but it will be consistent with other optimizers.</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stray_delta</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">fx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span></div>


    <span class="k">def</span> <span class="nf">_bounded_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="c1"># Force the fit point into the valid region</span>
        <span class="n">stray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stray_delta</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">stray_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stray</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stray_cost</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stray_cost</span> <span class="o">+=</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">stray</span><span class="p">)</span>
        <span class="c1"># treat prior probabilities on the parameters as additional</span>
        <span class="c1"># measurements</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">residuals</span><span class="p">()</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameter_residuals</span><span class="p">()))</span>
        <span class="c1"># Tally costs for straying outside the boundaries plus other costs</span>
        <span class="n">extra_cost</span> <span class="o">=</span> <span class="n">stray_cost</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">constraints_nllf</span><span class="p">()</span>
        <span class="c1"># Spread the cost over the residuals.  Since we are smoothly increasing</span>
        <span class="c1"># residuals as we leave the boundary, this should push us back into the</span>
        <span class="c1"># boundary (within tolerance) during the lm fit.</span>
        <span class="n">residuals</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">extra_cost</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">residuals</span>

    <span class="k">def</span> <span class="nf">_stray_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;calculate how far point is outside the boundary&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<div class="viewcode-block" id="LevenbergMarquardtFit.cov">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.LevenbergMarquardtFit.cov">[docs]</a>
    <span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span></div>
</div>



<div class="viewcode-block" id="SnobFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.SnobFit">[docs]</a>
<span class="k">class</span> <span class="nc">SnobFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;SNOBFIT&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;snobfit&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)]</span>

<div class="viewcode-block" id="SnobFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.SnobFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="c1"># TODO: no mapper??</span>
        <span class="kn">from</span> <span class="nn">snobfit.snobfit</span> <span class="kn">import</span> <span class="n">snobfit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">snobfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">(),</span>
                           <span class="n">fglob</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">improved</span><span class="p">):</span>
        <span class="c1"># TODO: snobfit does have a population...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">fx</span><span class="p">,</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">population_values</span><span class="o">=</span><span class="p">[</span><span class="n">fx</span><span class="p">])</span></div>



<div class="viewcode-block" id="DreamModel">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamModel">[docs]</a>
<span class="k">class</span> <span class="nc">DreamModel</span><span class="p">(</span><span class="n">MCMCModel</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DREAM wrapper for fit problems.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a sampling from the multidimensional likelihood function</span>
<span class="sd">        represented by the problem set using dream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print &quot;dream&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span> <span class="k">if</span> <span class="n">mapper</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

<div class="viewcode-block" id="DreamModel.log_density">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamModel.log_density">[docs]</a>
    <span class="k">def</span> <span class="nf">log_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nllf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="DreamModel.nllf">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamModel.nllf">[docs]</a>
    <span class="k">def</span> <span class="nf">nllf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Negative log likelihood of seeing models given *x*&quot;&quot;&quot;</span>
        <span class="c1"># Note: usually we will be going through the provided mapper, and</span>
        <span class="c1"># this function will never be called.</span>
        <span class="c1"># print &quot;eval&quot;,x; sys.stdout.flush()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="DreamModel.map">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamModel.map">[docs]</a>
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pop</span><span class="p">):</span>
        <span class="c1"># print &quot;calling mapper&quot;,self.mapper</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="DreamFit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit">[docs]</a>
<span class="k">class</span> <span class="nc">DreamFit</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;DREAM&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;dream&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;burn&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;thin&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outliers&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;trim&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># deprecated: use --samples instead</span>
               <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="n">FitBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span> <span class="o">=</span> <span class="n">DreamModel</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DreamFit.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.dream</span> <span class="kn">import</span> <span class="n">Dream</span>
        <span class="k">if</span> <span class="n">abort_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort_test</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mapper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span> <span class="o">=</span> <span class="n">MonitorRunner</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                     <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">)</span>

        <span class="n">population</span> <span class="o">=</span> <span class="n">initpop</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="n">pop_size</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">draws</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">]),</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">draws</span> <span class="o">+</span> <span class="n">pop_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">pop_size</span>
        <span class="c1"># TODO: need a better way to announce number of steps</span>
        <span class="c1"># maybe somehow print iteration # of # iters in the monitor?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# steps: </span><span class="si">%d</span><span class="s2">, # draws: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">pop_size</span><span class="o">*</span><span class="n">steps</span><span class="p">))</span>
        <span class="n">population</span> <span class="o">=</span> <span class="n">population</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">Dream</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="n">population</span><span class="p">,</span>
                        <span class="n">draws</span><span class="o">=</span><span class="n">pop_size</span> <span class="o">*</span> <span class="n">steps</span><span class="p">,</span>
                        <span class="n">burn</span><span class="o">=</span><span class="n">pop_size</span> <span class="o">*</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;burn&#39;</span><span class="p">],</span>
                        <span class="n">thinning</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">],</span>
                        <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                        <span class="n">outlier_test</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;outliers&#39;</span><span class="p">],</span>
                        <span class="n">DE_noise</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">abort_test</span><span class="o">=</span><span class="n">abort_test</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trimmed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">trim_portion</span><span class="p">()</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;trim&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="c1">#print(&quot;trimming&quot;, options[&#39;trim&#39;], self._trimmed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mark_outliers</span><span class="p">(</span><span class="n">portion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trimmed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">keep_best</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># TODO: Temporary hack to apply a post-mcmc action to the state vector</span>
        <span class="c1"># The problem is that if we manipulate the state vector before saving</span>
        <span class="c1"># it then we will not be able to use the --resume feature.  We can</span>
        <span class="c1"># get around this by just not writing state for the derived variables,</span>
        <span class="c1"># at which point we can remove this notice.</span>
        <span class="c1"># TODO: Add derived/visible variable support to other optimizers</span>
        <span class="n">fn</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;derive_vars&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">derive_vars</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">visible_vars</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;visible_vars&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">visible_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_visible_vars</span><span class="p">(</span><span class="n">visible_vars</span><span class="p">)</span>
        <span class="n">integer_vars</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;integer_vars&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integer_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_integer_vars</span><span class="p">(</span><span class="n">integer_vars</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">best</span><span class="p">()</span>

        <span class="c1"># Check that the last point is the best point</span>
        <span class="c1">#points, logp = self.state.sample()</span>
        <span class="c1">#assert logp[-1] == fx</span>
        <span class="c1">#print(points[-1], x)</span>
        <span class="c1">#assert all(points[-1, i] == xi for i, xi in enumerate(x))</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">fx</span></div>


<div class="viewcode-block" id="DreamFit.entropy">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.entropy">[docs]</a>
    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">portion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trimmed</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">logp</span><span class="p">):</span>
        <span class="c1"># Get an early copy of the state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">uncertainty_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">generation</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">best</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="n">fx</span><span class="p">,</span>
                     <span class="n">population_points</span><span class="o">=</span><span class="n">pop</span><span class="p">,</span> <span class="n">population_values</span><span class="o">=-</span><span class="n">logp</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="DreamFit.stderr">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.stderr">[docs]</a>
    <span class="k">def</span> <span class="nf">stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approximate standard error as 1/2 the 68% interval fo the sample,</span>
<span class="sd">        which is a more robust measure than the mean of the sample for</span>
<span class="sd">        non-normal distributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.dream.stats</span> <span class="kn">import</span> <span class="n">var_stats</span>

        <span class="n">vstats</span> <span class="o">=</span> <span class="n">var_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">portion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trimmed</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">v</span><span class="o">.</span><span class="n">p68</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">p68</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vstats</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span></div>


    <span class="c1">#def cov(self):</span>
    <span class="c1">#    # Covariance estimate from final 1000 points</span>
    <span class="c1">#    return np.cov(self.state.draw().points[-1000:])</span>

<div class="viewcode-block" id="DreamFit.load">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.dream.state</span> <span class="kn">import</span> <span class="n">load_state</span><span class="p">,</span> <span class="n">path_contains_saved_state</span>
        <span class="k">if</span> <span class="n">path_contains_saved_state</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading saved state from </span><span class="si">%s</span><span class="s2"> (this might take awhile) ...&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">input_path</span><span class="p">,))</span>
            <span class="n">fn</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;derive_vars&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">load_state</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">derived_vars</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Warn if mc files are not found on --resume path</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No mcmc found; ignoring --resume=</span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">input_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="DreamFit.save">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="DreamFit.plot">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">figfile</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">portion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trimmed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_plot</span><span class="p">(</span><span class="n">figfile</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="DreamFit.show">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.show">[docs]</a>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DreamFit.error_plot">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.DreamFit.error_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">error_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figfile</span><span class="p">):</span>
        <span class="c1"># Produce error plot</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">errplot</span>
        <span class="c1"># TODO: shouldn&#39;t mix calc and display!</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">errplot</span><span class="o">.</span><span class="n">calc_errors_from_state</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dream_model</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                             <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                             <span class="n">portion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trimmed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">errplot</span><span class="o">.</span><span class="n">show_errors</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span> <span class="o">+</span> <span class="s2">&quot;-errors.png&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Resampler">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.Resampler">[docs]</a>
<span class="k">class</span> <span class="nc">Resampler</span><span class="p">(</span><span class="n">FitBase</span><span class="p">):</span>
    <span class="c1"># TODO: why isn&#39;t cli.resynth using this?</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitter</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="Resampler.solve">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.Resampler.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">restart</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">_resampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">starts</span><span class="p">,</span>
                            <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>  <span class="c1"># save points for later plotting</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span></div>
</div>



<span class="k">def</span> <span class="nf">_resampler</span><span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="n">xinit</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refit the result multiple times with resynthesized data, building</span>
<span class="sd">    up an array in Result.samples which contains the best fit to the</span>
<span class="sd">    resynthesized data.  *samples* is the number of samples to generate.</span>
<span class="sd">    *fitter* is the (local) optimizer to use. **kw are the parameters</span>
<span class="sd">    for the optimizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xinit</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>  <span class="c1"># TODO: some solvers already catch KeyboardInterrupt</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
            <span class="c1"># print &quot;== resynth %d of %d&quot; % (i, samples)</span>
            <span class="n">fitter</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">resynth_data</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
                <span class="n">fitter</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">randomize</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fitter</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">fx</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
            <span class="c1"># print self.problem.summarize()</span>
            <span class="c1"># print &quot;[chisq=%g]&quot; % (nllf*2/self.problem.dof)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="c1"># On keyboard interrupt we can declare that we are finished sampling</span>
        <span class="c1"># without it being an error condition, so let this exception pass.</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Restore the state of the problem</span>
        <span class="n">fitter</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">restore_data</span><span class="p">()</span>
        <span class="n">fitter</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>
        <span class="c1">#fitter.problem.model_update()  # setp does model update</span>
    <span class="k">return</span> <span class="n">points</span>


<div class="viewcode-block" id="FitDriver">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver">[docs]</a>
<span class="k">class</span> <span class="nc">FitDriver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">problem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">abort_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitclass</span> <span class="o">=</span> <span class="n">fitclass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitors</span> <span class="o">=</span> <span class="n">monitors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abort_test</span> <span class="o">=</span> <span class="n">abort_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span> <span class="k">if</span> <span class="n">mapper</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">nllf</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="FitDriver.fit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.fit">[docs]</a>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cov&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_stderr&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resume</span><span class="p">:</span>
            <span class="n">fitter</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starts&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">starts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fitter</span> <span class="o">=</span> <span class="n">MultiStart</span><span class="p">(</span><span class="n">fitter</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitter</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">monitors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitors</span><span class="p">,</span>
                             <span class="n">abort_test</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">abort_test</span><span class="p">,</span>
                             <span class="n">mapper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span>
                             <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">fx</span></div>


<div class="viewcode-block" id="FitDriver.clip">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.clip">[docs]</a>
    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force parameters within bounds so constraints are finite.</span>

<span class="sd">        The problem is updated with the new parameter values.</span>

<span class="sd">        Returns a list of parameter names that were clipped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span>
        <span class="n">new_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">new_values</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clipped</span></div>


<div class="viewcode-block" id="FitDriver.entropy">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.entropy">[docs]</a>
    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.dream</span> <span class="kn">import</span> <span class="n">entropy</span>
            <span class="k">return</span> <span class="n">entropy</span><span class="o">.</span><span class="n">cov_entropy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">()),</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="FitDriver.chisq">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.chisq">[docs]</a>
    <span class="k">def</span> <span class="nf">chisq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_chisq&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chisq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">chisq</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chisq</span></div>


<div class="viewcode-block" id="FitDriver.cov">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.cov">[docs]</a>
    <span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an estimate of the covariance of the fit.</span>

<span class="sd">        Depending on the fitter and the problem, this may be computed from</span>
<span class="sd">        existing evaluations within the fitter, or from numerical</span>
<span class="sd">        differentiation around the minimum.</span>

<span class="sd">        If the problem uses $\chi^2/2$ as its nllf, then the covariance</span>
<span class="sd">        is derived from the Jacobian::</span>

<span class="sd">            x = fit.problem.getp()</span>
<span class="sd">            J = bumps.lsqerror.jacobian(fit.problem, x)</span>
<span class="sd">            cov = bumps.lsqerror.jacobian_cov(J)</span>

<span class="sd">        Otherwise, the numerical differentiation will use the Hessian</span>
<span class="sd">        estimated from nllf::</span>

<span class="sd">            x = fit.problem.getp()</span>
<span class="sd">            H = bumps.lsqerror.hessian(fit.problem, x)</span>
<span class="sd">            cov = bumps.lsqerror.hessian_cov(H)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: if fit() has not been run then self.fitter is None and in</span>
        <span class="c1"># particular, self.fitter will not have a covariance matrix.  In</span>
        <span class="c1"># this case, the code will fall through to computing the covariance</span>
        <span class="c1"># matrix directly from the problem.  It will use the initial value</span>
        <span class="c1"># stored in the problem parameters because results will also be None.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cov&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;cov&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
                <span class="c1">#print(&quot;fitter cov&quot;, self._cov)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use Jacobian if residuals are available because it is faster</span>
            <span class="c1"># to compute.  Otherwise punt and use Hessian.  The has_residuals</span>
            <span class="c1"># attribute should be True if present.  It may be false if</span>
            <span class="c1"># the problem defines a residuals method but doesn&#39;t really</span>
            <span class="c1"># have residuals (e.g. to allow levenberg-marquardt to run even</span>
            <span class="c1"># though it is not fitting a sum-square problem).</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;has_residuals&#39;</span><span class="p">):</span>
                <span class="n">has_residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">has_residuals</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_residuals</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;residuals&#39;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">has_residuals</span><span class="p">:</span>
                <span class="n">J</span> <span class="o">=</span> <span class="n">lsqerror</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="c1">#print(&quot;Jacobian&quot;, J)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="n">lsqerror</span><span class="o">.</span><span class="n">jacobian_cov</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">lsqerror</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="c1">#print(&quot;Hessian&quot;, H)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span> <span class="o">=</span> <span class="n">lsqerror</span><span class="o">.</span><span class="n">hessian_cov</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov</span></div>


<div class="viewcode-block" id="FitDriver.stderr">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.stderr">[docs]</a>
    <span class="k">def</span> <span class="nf">stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an estimate of the standard error of the fit.</span>

<span class="sd">        Depending on the fitter and the problem, this may be computed from</span>
<span class="sd">        existing evaluations within the fitter, or from numerical</span>
<span class="sd">        differentiation around the minimum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: if fit() has not been run then self.fitter is None and in</span>
        <span class="c1"># particular, self.fitter will not have a stderr method defined so</span>
        <span class="c1"># it will compute stderr from covariance.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_stderr&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">stderr</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If no stderr from the fitter then compute it from the covariance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_from_cov</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr</span></div>


<div class="viewcode-block" id="FitDriver.stderr_from_cov">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.stderr_from_cov">[docs]</a>
    <span class="k">def</span> <span class="nf">stderr_from_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an estimate of standard error of the fit from covariance matrix.</span>

<span class="sd">        Unlike stderr, which uses the estimate from the underlying</span>
<span class="sd">        fitter (DREAM uses the MCMC sample for this), *stderr_from_cov*</span>
<span class="sd">        estimates the error from the diagonal of the covariance matrix.</span>
<span class="sd">        Here, the covariance matrix may have been estimated by the fitter</span>
<span class="sd">        instead of the Hessian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_stderr_from_cov&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_from_cov</span> <span class="o">=</span> <span class="n">lsqerror</span><span class="o">.</span><span class="n">stderr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stderr_from_cov</span></div>


<div class="viewcode-block" id="FitDriver.show">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.show">[docs]</a>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



    <span class="c1"># TODO: reenable the &quot;implied variance&quot; calculation</span>
    <span class="k">def</span> <span class="nf">_unused_show_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the error approximation from the numerical derivative.</span>

<span class="sd">        Warning: cost grows as the cube of the number of parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: need cheaper uncertainty estimate</span>
        <span class="c1"># Note: error estimated from hessian diagonal is insufficient.</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_from_cov</span><span class="p">()</span>
        <span class="c1"># TODO: citation needed</span>
        <span class="c1"># The &quot;implied variance&quot; column is obtained by scaling the covariance</span>
        <span class="c1"># matrix so that chisq = DOF. Any excess chisq implies increased</span>
        <span class="c1"># variance in the measurements, so increased variance in the parameters.</span>
        <span class="c1"># This is well defined for linear systems with equal but unknown</span>
        <span class="c1"># variance in each measurement, and assumed to be approximately true</span>
        <span class="c1"># for nonlinear systems, with the unexplained variance distributed</span>
        <span class="c1"># proportionately amongst the measurement uncertainties.</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chisq</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Uncertainty from curvature:     name&quot;</span>
              <span class="s2">&quot; value(unc.)    &quot;</span>
              <span class="s2">&quot; value(unc./chi)) ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">labels</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span> <span class="n">err</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%40s</span><span class="s2"> </span><span class="si">%-15s</span><span class="s2"> </span><span class="si">%-15s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span>
                  <span class="n">format_uncertainty</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dv</span><span class="p">),</span>
                  <span class="n">format_uncertainty</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dv</span><span class="o">/</span><span class="n">norm</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">75</span><span class="p">)</span>

<div class="viewcode-block" id="FitDriver.show_err">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.show_err">[docs]</a>
    <span class="k">def</span> <span class="nf">show_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the error approximation from the numerical derivative.</span>

<span class="sd">        Warning: cost grows as the cube of the number of parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: need cheaper uncertainty estimate</span>
        <span class="c1"># Note: error estimated from hessian diagonal is insufficient.</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_from_cov</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Uncertainty from curvature:     name   value(unc.) ===&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">labels</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">(),</span> <span class="n">err</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">&gt;40s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">format_uncertainty</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">dv</span><span class="p">)</span><span class="si">:</span><span class="s2">&lt;15s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">58</span><span class="p">)</span></div>


<div class="viewcode-block" id="FitDriver.show_cov">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.show_cov">[docs]</a>
    <span class="k">def</span> <span class="nf">show_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
        <span class="n">maxn</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># max array dims to print</span>
        <span class="n">cov_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span>
            <span class="n">cov</span><span class="p">,</span>
            <span class="n">max_line_width</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">maxn</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">maxn</span><span class="o">*</span><span class="n">maxn</span><span class="p">,</span>
            <span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="c1">#suppress_small=True,</span>
            <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Covariance matrix ===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cov_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=========================&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FitDriver.show_entropy">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.show_entropy">[docs]</a>
    <span class="k">def</span> <span class="nf">show_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating entropy...&quot;</span><span class="p">)</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">dS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entropy: </span><span class="si">%s</span><span class="s2"> bits&quot;</span> <span class="o">%</span> <span class="n">format_uncertainty</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">dS</span><span class="p">))</span></div>


<div class="viewcode-block" id="FitDriver.save">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="c1"># print &quot;calling driver save&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="FitDriver.load">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">):</span>
        <span class="c1"># print &quot;calling driver save&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="FitDriver.plot">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.FitDriver.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># print &quot;calling fitter.plot&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figfile</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_save_fit_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitclass</span><span class="o">.</span><span class="n">id</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_from_cov</span><span class="p">()</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span><span class="p">()</span>

        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;fitter&#39;</span><span class="p">:</span> <span class="n">fitter</span><span class="p">,</span>
        <span class="p">}</span></div>



<span class="k">def</span> <span class="nf">_fill_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns options dict with missing values filled from settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># settings is a list of (key,value) pairs</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="n">FITTERS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">FIT_AVAILABLE_IDS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">FIT_ACTIVE_IDS</span> <span class="o">=</span> <span class="p">[]</span>
<div class="viewcode-block" id="register">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.register">[docs]</a>
<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a new fitter with bumps, if it is not already there.</span>

<span class="sd">    *active* is False if you don&#39;t want it showing up in the GUI selector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if already registered.</span>
    <span class="k">if</span> <span class="n">fitter</span> <span class="ow">in</span> <span class="n">FITTERS</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Check that there is no other fitter of that name</span>
    <span class="k">if</span> <span class="n">fitter</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">FIT_AVAILABLE_IDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is already a fitter registered as </span><span class="si">%r</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="n">fitter</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># Register the fitter.</span>
    <span class="n">FITTERS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitter</span><span class="p">)</span>
    <span class="n">FIT_AVAILABLE_IDS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># Make it &quot;active&quot; by listing it in the help menu.</span>
    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">FIT_ACTIVE_IDS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>


<span class="c1"># Register the fitters</span>
<span class="n">register</span><span class="p">(</span><span class="n">SimplexFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="n">DEFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="n">DreamFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="n">BFGSFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="n">LevenbergMarquardtFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="n">MPFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#register(PSFit, active=False)</span>
<span class="n">register</span><span class="p">(</span><span class="n">PTFit</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#register(RLFit, active=False)</span>
<span class="c1">#register(SnobFit, active=False)</span>

<span class="n">FIT_DEFAULT_ID</span> <span class="o">=</span> <span class="n">SimplexFit</span><span class="o">.</span><span class="n">id</span>

<span class="k">assert</span> <span class="n">FIT_DEFAULT_ID</span> <span class="ow">in</span> <span class="n">FIT_ACTIVE_IDS</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">FIT_AVAILABLE_IDS</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">FIT_ACTIVE_IDS</span><span class="p">)</span>

<div class="viewcode-block" id="fit">
<a class="viewcode-back" href="../../bumps.fitters.html#bumps.fitters.fit">[docs]</a>
<span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">FIT_DEFAULT_ID</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified fit interface.</span>

<span class="sd">    Given a fit problem, the name of a fitter and the fitter options,</span>
<span class="sd">    it will run the fit and return the best value and standard error of</span>
<span class="sd">    the parameters.  If *verbose* is true, then the console monitor will</span>
<span class="sd">    be enabled, showing progress through the fit and showing the parameter</span>
<span class="sd">    standard error at the end of the fit, otherwise it is completely</span>
<span class="sd">    silent.</span>

<span class="sd">    Returns an *OptimizeResult* object containing &quot;x&quot; and &quot;dx&quot;.  The</span>
<span class="sd">    dream fitter also includes the &quot;state&quot; object, allowing for more</span>
<span class="sd">    detailed uncertainty analysis.  Optimizer information such as the</span>
<span class="sd">    stopping condition and the number of function evaluations are not</span>
<span class="sd">    yet included.</span>

<span class="sd">    To run in parallel (with multiprocessing and dream)::</span>

<span class="sd">        from bumps.mapper import MPMapper</span>
<span class="sd">        mapper = MPMapper.start_mapper(problem, None, cpu=0) #cpu=0 for all CPUs</span>
<span class="sd">        result = fit(problem, method=&quot;dream&quot;, mapper=mapper)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>

    <span class="c1">#verbose = True</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FIT_AVAILABLE_IDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown method </span><span class="si">%r</span><span class="s2"> not one of </span><span class="si">%s</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">FIT_ACTIVE_IDS</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">fitclass</span> <span class="ow">in</span> <span class="n">FITTERS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fitclass</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">monitors</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="p">[]</span>  <span class="c1"># default is step monitor</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">FitDriver</span><span class="p">(</span>
        <span class="n">fitclass</span><span class="o">=</span><span class="n">fitclass</span><span class="p">,</span> <span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">monitors</span><span class="o">=</span><span class="n">monitors</span><span class="p">,</span>
        <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">clip</span><span class="p">()</span> <span class="c1"># make sure fit starts within domain</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">getp</span><span class="p">()</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">stderr</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final chisq&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">chisq_str</span><span class="p">())</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">show_err</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">OptimizeResult</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">driver</span><span class="o">.</span><span class="n">stderr</span><span class="p">(),</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">fx</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;successful termination&quot;</span><span class="p">,</span>
        <span class="c1">#nit=0, # number of iterations</span>
        <span class="c1">#nfev=0, # number of function evaluations</span>
        <span class="c1">#njev, nhev # jacobian and hessian evaluations</span>
        <span class="c1">#maxcv=0, # max constraint violation</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">fitter</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">fitter</span><span class="o">.</span><span class="n">state</span>
    <span class="k">return</span> <span class="n">result</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../bumps.html" >bumps</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bumps.fitters</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>