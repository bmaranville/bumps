<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Server installation &#8212; Bumps 0.9.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <script src="../_static/documentation_options.js?v=9dc39874"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing Changes" href="contributing.html" />
    <link rel="prev" title="Installing the application" href="install.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="contributing.html" title="Contributing Changes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installing the application"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Getting Started</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Server installation</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="server-installation">
<span id="id1"></span><h1>Server installation<a class="headerlink" href="#server-installation" title="Link to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The remote fitting feature is not actively maintained and will likely
not work.</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#job-controller" id="id2">Job Controller</a></p></li>
<li><p><a class="reference internal" href="#cluster" id="id3">Cluster</a></p></li>
<li><p><a class="reference internal" href="#security" id="id4">Security</a></p></li>
</ul>
</nav>
<p>Bumps jobs can be submitted to a remote batch queue for processing.  This
allows users to share large clusters for faster processing of the data.  The
queue consists of several components.</p>
<ul>
<li><p>job controller</p>
<blockquote>
<div><p>http service layer which allows users to submit jobs and view results</p>
</div></blockquote>
</li>
<li><p>queue</p>
<blockquote>
<div><p>cluster management layer which distributes jobs to the working nodes</p>
</div></blockquote>
</li>
<li><p>worker</p>
<blockquote>
<div><p>process monitor which runs a job on the working nodes</p>
</div></blockquote>
</li>
<li><p>mapper</p>
<blockquote>
<div><p>mechanism for evaluating R(x_i) for different x_i on separate CPUs</p>
</div></blockquote>
</li>
</ul>
<p>If you are setting up a local cluster for performing Bumps analysis then you
will need to read this section, otherwise you can continue to the next section.</p>
<p>Assuming that the bumps server is installed as user ‘bumps’ in a virtualenv
of ~/bumpserve, MPLCONFIGDIR is set to ~/bumpserve/.matplotlib,
and bumpworkd has been configured, you can start with the following profile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TODO</span><span class="p">:</span> <span class="n">fill</span> <span class="ow">in</span> <span class="n">some</span> <span class="n">details</span> <span class="n">on</span> <span class="n">bumps</span> <span class="n">server</span>
</pre></div>
</div>
<section id="job-controller">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Job Controller</a><a class="headerlink" href="#job-controller" title="Link to this heading">¶</a></h2>
<p><em>extra/jobqueue</em> is an independent package within bumps.  It implements
an http API for interacting with jobs.</p>
<p>It is implemented as a WSGI python application using
<a class="reference external" href="http://flask.pocoo.org">Flask</a></p>
<p>Here is our WSGI setup for apache for our reflectometry modeling service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">VirtualHost</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span><span class="o">&gt;</span>
    <span class="n">ServerAdmin</span> <span class="n">pkienzle</span><span class="nd">@nist</span><span class="o">.</span><span class="n">gov</span>
    <span class="n">ServerName</span> <span class="n">www</span><span class="o">.</span><span class="n">reflectometry</span><span class="o">.</span><span class="n">org</span>
    <span class="n">ServerAlias</span> <span class="n">reflectometry</span><span class="o">.</span><span class="n">org</span>
    <span class="n">ErrorLog</span> <span class="n">logs</span><span class="o">/</span><span class="n">bumps</span><span class="o">-</span><span class="n">error_log</span>
    <span class="n">CustomLog</span> <span class="n">logs</span><span class="o">/</span><span class="n">bumps</span><span class="o">-</span><span class="n">access_log</span> <span class="n">common</span>

    <span class="n">WSGIDaemonProcess</span> <span class="n">bumps_serve</span> <span class="n">user</span><span class="o">=</span><span class="n">pkienzle</span> <span class="n">group</span><span class="o">=</span><span class="n">refl</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">WSGIScriptAlias</span> <span class="o">/</span><span class="n">queue</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pkienzle</span><span class="o">/</span><span class="n">bumps</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">jobqueue</span><span class="o">.</span><span class="n">wsgi</span>

    <span class="o">&lt;</span><span class="n">Directory</span> <span class="s2">&quot;/home/pkienzle/bumps/www&quot;</span><span class="o">&gt;</span>
            <span class="n">WSGIProcessGroup</span> <span class="n">bumps_serve</span>
            <span class="n">WSGIApplicationGroup</span> <span class="o">%</span><span class="p">{</span><span class="n">GLOBAL</span><span class="p">}</span>
            <span class="n">Order</span> <span class="n">deny</span><span class="p">,</span><span class="n">allow</span>
            <span class="n">Allow</span> <span class="kn">from</span> <span class="nn">all</span>
    <span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>

    <span class="n">DocumentRoot</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">bumps</span>
    <span class="o">&lt;</span><span class="n">Directory</span> <span class="s2">&quot;/var/www/bumps/&quot;</span><span class="o">&gt;</span>
            <span class="n">AllowOverride</span> <span class="n">All</span>
    <span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">VirtualHost</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>There is a choice of two different queuing systems to configure.  If your
environment supports a traditional batch queue you can use it to
manage cluster resources.  New jobs are added to the queue, and
when they are complete, they leave their results in the job results
directory.  Currently only slurm is supported, but supporting torque
as well would only require a few changes.</p>
<p>You can also set up a central dispatcher.  In that case, you will have
remote clusters pull jobs from the server when they are available, and post
the results to the job results directory when they are complete. The remote
cluster may be set up with its own queuing system such as slurm, only
taking a few jobs at a time from the dispatcher so that other clusters
can share the load.</p>
</section>
<section id="cluster">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Cluster</a><a class="headerlink" href="#cluster" title="Link to this heading">¶</a></h2>
<p>If you are using the dispatcher queuing system, you will need to set up
a work daemon on your cluster to pull jobs from the queue.  This requires
adding bumpworkd to your OS initialization scripts.</p>
</section>
<section id="security">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Security</a><a class="headerlink" href="#security" title="Link to this heading">¶</a></h2>
<p>Because the jobqueue can run without authentication we need to be
especially concerned about the security of our system.  Techniques
such as AppArmor or virtual machines with memory mapped file systems
provide a relatively safe environment to support anonymous computing.</p>
<p>To successfully set up AppArmor, there are a few operations you need.</p>
<p>Each protected application needs a profile, usually stored in
/etc/apparmor.d/path.to.application.  With the reflenv virtural
environment in the reflectometry user, the following profile
would be appropriate for the worker daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">home</span><span class="o">.</span><span class="n">bumps</span><span class="o">.</span><span class="n">bumpsenv</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">bumpworkd</span>
<span class="c1">#include &lt;tunables/global&gt;</span>

<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bumps</span><span class="o">/</span><span class="n">bumpsenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bumpworkd</span> <span class="p">{</span>
 <span class="c1">#include &lt;abstractions/base&gt;</span>
 <span class="c1">#include &lt;abstractions/python&gt;</span>

 <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">dash</span> <span class="n">cx</span><span class="p">,</span>
 <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bumps</span><span class="o">/</span><span class="n">bumpsenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="n">cx</span><span class="p">,</span>
 <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bumps</span><span class="o">/</span><span class="n">bumpsenv</span><span class="o">/**</span> <span class="n">r</span><span class="p">,</span>
 <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bumps</span><span class="o">/</span><span class="n">bumpsenv</span><span class="o">/**.</span><span class="p">{</span><span class="n">so</span><span class="p">,</span><span class="n">pyd</span><span class="p">}</span> <span class="n">mr</span><span class="p">,</span>
 <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bumps</span><span class="o">/.</span><span class="n">bumpserve</span><span class="o">/.</span><span class="n">matplotlib</span><span class="o">/*</span> <span class="n">rw</span><span class="p">,</span>
 <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bumps</span><span class="o">/.</span><span class="n">bumpserve</span><span class="o">/</span><span class="n">worker</span><span class="o">/**</span> <span class="n">rw</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This gives read/execute access to python and its C extensions,
and read access to everything else in the bumps virtual environment.</p>
<p>The rw access to .bumpserve is potentially problematic.  Hostile
models can interfere with each other if they are running at the same time.
In particular, they could inject html into the returned data set which can
effectively steal authentication credentials from other users through
cross site scripting attacks, and so would not be appropriate on an
authenticated service.  Restricting individual models to their own job
directory at .bumpserve/worker/jobid/** would reduce this risk, but this
author does not know how to do so without elevating bumpworkd privileges to root.</p>
<p>Once the profile is in place, restart the apparmor.d daemon to enable it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">apparmor</span> <span class="n">restart</span>
</pre></div>
</div>
<p>You can debug the profile by running a trace while the program runs
unrestricted.  To start the trace, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">genprof</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">application</span>
</pre></div>
</div>
<p>Switch to another window then run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">app</span>
</pre></div>
</div>
<p>When your application is complete, return to the genprof window
and hit ‘S’ to scan /var/log/syslog for file and network access.
Follow the prompts to update the profile.  The documentation on
<a class="reference external" href="https://help.ubuntu.com/community/AppArmor">AppArmor on Ubuntu</a>
and
<a class="reference external" href="http://doc.opensuse.org/products/opensuse/openSUSE/opensuse-security/cha.apparmor.profiles.html">AppArmor on SUSE</a>
is very helpful here.</p>
<p>To reload a profile after running the trace, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apparmor_parser</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">path</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">application</span>
</pre></div>
</div>
<p>To delete a profile that you no longer need:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">path</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">application</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">apparmor</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Similar profiles could be created for the job server, and indeed, any web
service you have on your machine to reduce the risk that bugs in your code
can be used to compromise your security, but this is less critical since
your code is not running in general running with arbitrary user defined functions.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Server installation</a><ul>
<li><a class="reference internal" href="#job-controller">Job Controller</a></li>
<li><a class="reference internal" href="#cluster">Cluster</a></li>
<li><a class="reference internal" href="#security">Security</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="install.html"
                          title="previous chapter">Installing the application</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="contributing.html"
                          title="next chapter">Contributing Changes</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/getting_started/server.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="contributing.html" title="Contributing Changes"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installing the application"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Bumps 0.9.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Getting Started</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Server installation</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>